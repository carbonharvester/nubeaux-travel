<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Itinerary | JUNO Creator Portal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-bg: #fafafa;
      --color-white: #ffffff;
      --color-text: #1a1a1a;
      --color-text-light: #6b6b6b;
      --color-border: #e5e5e5;
      --color-accent: #c2703e;
      --color-accent-light: #f5ebe4;
      --color-success: #22c55e;
      --color-error: #ef4444;
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-serif: 'Playfair Display', Georgia, serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    /* Top Bar */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: transparent;
      font-size: 0.875rem;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .top-bar-title {
      font-family: var(--font-display);
      font-size: 1.125rem;
    }

    .top-bar-actions {
      display: flex;
      gap: 12px;
    }

    /* Completion Meter */
    .completion-meter {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--color-bg);
      border-radius: 8px;
      margin-right: 16px;
    }

    .completion-meter-label {
      font-size: 0.75rem;
      color: var(--color-text-light);
      white-space: nowrap;
    }

    .completion-meter-bar {
      width: 120px;
      height: 6px;
      background: var(--color-border);
      border-radius: 3px;
      overflow: hidden;
    }

    .completion-meter-fill {
      height: 100%;
      background: var(--color-accent);
      border-radius: 3px;
      transition: width 0.3s ease, background-color 0.3s;
    }

    .completion-meter-fill.low { background: #ef4444; }
    .completion-meter-fill.medium { background: #f59e0b; }
    .completion-meter-fill.high { background: #22c55e; }

    .completion-meter-percent {
      font-size: 0.875rem;
      font-weight: 600;
      min-width: 36px;
    }

    .completion-meter-percent.low { color: #ef4444; }
    .completion-meter-percent.medium { color: #f59e0b; }
    .completion-meter-percent.high { color: #22c55e; }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      border: none;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .btn-outline:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .btn-primary {
      background: var(--color-accent);
      color: white;
    }

    .btn-primary:hover {
      background: #a85d32;
    }

    /* Main Layout */
    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      margin-top: 60px;
      min-height: calc(100vh - 60px);
    }

    .editor-main {
      padding: 32px 48px;
      max-width: 900px;
    }

    .editor-sidebar {
      background: var(--color-white);
      border-left: 1px solid var(--color-border);
      padding: 24px;
      position: sticky;
      top: 60px;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 40px;
    }

    .form-section-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--color-border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--color-text);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: var(--font-sans);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-light);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* AI Wand */
    .textarea-wrapper {
      position: relative;
    }

    .ai-wand-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 5;
    }

    .ai-wand-btn:hover {
      border-color: #8b5cf6;
      background: #f5f3ff;
    }

    .ai-wand-btn svg {
      width: 16px;
      height: 16px;
      color: #8b5cf6;
    }

    .ai-wand-btn.loading {
      pointer-events: none;
    }

    .ai-wand-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .ai-menu {
      position: absolute;
      top: 44px;
      right: 8px;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10;
      min-width: 180px;
      display: none;
    }

    .ai-menu.show {
      display: block;
    }

    .ai-menu-header {
      padding: 10px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-light);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-menu-header svg {
      width: 12px;
      height: 12px;
      color: #8b5cf6;
    }

    .ai-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      font-size: 0.875rem;
      color: var(--color-text);
      cursor: pointer;
      text-align: left;
      transition: background 0.15s;
    }

    .ai-menu-item:hover {
      background: var(--color-bg);
    }

    .ai-menu-item svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-light);
    }

    .ai-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-hint {
      font-size: 0.8125rem;
      color: var(--color-text-light);
      margin-top: 6px;
    }

    /* Hero Image Upload */
    .hero-upload {
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .hero-upload:hover {
      border-color: var(--color-accent);
    }

    .hero-upload.has-image {
      padding: 0;
      border-style: solid;
    }

    .hero-upload img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .hero-upload-content {
      color: var(--color-text-light);
    }

    .hero-upload-content svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .hero-upload input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Day Cards */
    .days-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .day-card {
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .day-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
    }

    .day-card-header h3 {
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .day-number {
      width: 28px;
      height: 28px;
      background: var(--color-accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .day-card-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-white);
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    .day-card-content {
      padding: 20px;
    }

    /* Media Grid */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .media-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .media-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-item-add {
      border: 2px dashed var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-light);
      transition: all 0.2s;
    }

    .media-item-add:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .media-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .media-item:hover .media-item-remove {
      opacity: 1;
    }

    .media-item-remove svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    /* Gallery Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .gallery-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: var(--color-bg);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .gallery-item:hover .gallery-item-remove {
      opacity: 1;
    }

    .gallery-item-remove svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .gallery-item-video::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpolygon points='5 3 19 12 5 21 5 3'/%3E%3C/svg%3E") center/50% no-repeat;
      border-radius: 50%;
    }

    /* Add Day Button */
    .add-day-btn {
      width: 100%;
      padding: 16px;
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      background: transparent;
      color: var(--color-text-light);
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .add-day-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    /* Sidebar Sections */
    .sidebar-section {
      margin-bottom: 28px;
    }

    .sidebar-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-light);
      margin-bottom: 12px;
    }

    /* Tags Input */
    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      min-height: 44px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--color-accent-light);
      color: var(--color-accent);
      border-radius: 20px;
      font-size: 0.8125rem;
    }

    .tag button {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      line-height: 1;
    }

    .tags-input input {
      flex: 1;
      min-width: 80px;
      border: none;
      outline: none;
      font-size: 0.875rem;
      padding: 4px;
    }

    /* Preview Panel */
    .preview-card {
      background: var(--color-bg);
      border-radius: 8px;
      overflow: hidden;
    }

    .preview-card-image {
      height: 120px;
      background: var(--color-border);
    }

    .preview-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-card-content {
      padding: 16px;
    }

    .preview-card-content h4 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .preview-card-content p {
      font-size: 0.8125rem;
      color: var(--color-text-light);
    }

    /* Status Badge */
    .status-toggle {
      display: flex;
      gap: 8px;
    }

    .status-option {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background: transparent;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-option.active {
      border-color: var(--color-accent);
      background: var(--color-accent-light);
      color: var(--color-accent);
    }

    .status-option[data-status="pending"].active {
      border-color: #8b5cf6;
      background: #f5f3ff;
      color: #7c3aed;
    }

    /* Stays List */
    .stays-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stay-item {
      padding: 16px;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 8px;
    }

    .stay-item-fields {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stay-item-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stay-item .form-input {
      padding: 10px 12px;
      font-size: 0.875rem;
    }

    .stay-gallery {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .stay-gallery-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
    }

    .stay-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .stay-gallery-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stay-gallery-add {
      width: 100px;
      height: 100px;
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      color: var(--color-text-light);
      transition: all 0.2s;
    }

    .stay-gallery-add:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .stay-gallery-add span {
      font-size: 0.75rem;
    }

    /* Hero image with preview */
    .hero-preview {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    }

    .hero-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .hero-preview-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
    }

    .hero-preview-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .hero-preview-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .hero-preview-btn svg {
      width: 18px;
      height: 18px;
      color: white;
    }

    .hero-focal-point {
      position: absolute;
      width: 36px;
      height: 36px;
      margin-left: -18px;
      margin-top: -18px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-accent);
      border-radius: 50%;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      transition: transform 0.1s;
    }

    .hero-focal-point:hover {
      transform: scale(1.1);
    }

    .hero-focal-point svg {
      width: 20px;
      height: 20px;
      color: var(--color-accent);
    }

    .hero-focal-hint {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .hero-preview:hover .hero-focal-hint {
      opacity: 1;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--color-text);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--color-success);
    }

    /* Instagram Content Import */
    .ig-import-section {
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .ig-import-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      color: white;
    }

    .ig-import-header svg {
      width: 24px;
      height: 24px;
    }

    .ig-import-header h3 {
      font-size: 1rem;
      font-weight: 500;
    }

    .ig-import-body {
      padding: 20px;
    }

    .ig-url-input {
      width: 100%;
      min-height: 120px;
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: var(--font-sans);
      font-size: 0.875rem;
      resize: vertical;
      line-height: 1.8;
    }

    .ig-url-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-light);
    }

    .ig-url-input::placeholder {
      color: var(--color-text-light);
    }

    .ig-import-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .ig-import-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
    }

    .ig-import-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .ig-import-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ig-import-btn.secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .ig-import-btn.secondary:hover {
      background: var(--color-surface-hover, #f5f5f5);
    }

    .ig-import-btn svg {
      width: 16px;
      height: 16px;
    }

    .ig-import-status {
      font-size: 0.8125rem;
      color: var(--color-text-light);
    }

    .ig-import-status.processing {
      color: #8b5cf6;
    }

    .ig-import-status.success {
      color: var(--color-success);
    }

    .ig-import-status.error {
      color: var(--color-error);
    }

    /* Imported Content Grid */
    .ig-content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--color-border);
    }

    .ig-content-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      background: var(--color-bg);
    }

    .ig-content-item img,
    .ig-content-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-content-item .video-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ig-content-item .video-indicator svg {
      width: 12px;
      height: 12px;
      color: white;
    }

    .ig-content-item .status-badge {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 4px 8px;
      font-size: 0.6875rem;
      text-align: center;
      color: white;
    }

    .ig-content-item .status-badge.pending {
      background: rgba(139, 92, 246, 0.9);
    }

    .ig-content-item .status-badge.processing {
      background: rgba(59, 130, 246, 0.9);
    }

    .ig-content-item .status-badge.ready {
      background: rgba(34, 197, 94, 0.9);
    }

    .ig-content-item .status-badge.failed {
      background: rgba(239, 68, 68, 0.9);
    }

    .ig-content-item .remove-btn {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ig-content-item:hover .remove-btn {
      opacity: 1;
    }

    .ig-content-item .remove-btn svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .ig-content-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 24px;
      color: var(--color-text-light);
    }

    .ig-content-empty svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      opacity: 0.4;
    }

    /* Imported Content Sections */
    .imported-section {
      margin-bottom: 20px;
    }
    .imported-section-title {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: 12px;
    }
    .imported-stories-scroll {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .imported-story-group {
      flex-shrink: 0;
      text-align: center;
      position: relative;
    }
    .story-highlight-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      padding: 2px;
      margin: 0 auto 6px;
    }
    .story-highlight-circle img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }
    .story-highlight-label {
      display: block;
      font-size: 0.6875rem;
      color: var(--color-text);
      max-width: 64px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .story-highlight-count {
      display: block;
      font-size: 0.625rem;
      color: var(--color-text-light);
    }
    .remove-btn-small {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-error, #dc3545);
      color: white;
      border: none;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .imported-posts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
    }

    /* Synced Posts Grid */
    .ig-posts-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }

    .ig-post-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s, transform 0.15s;
    }

    .ig-post-item:hover {
      transform: scale(1.02);
    }

    .ig-post-item.selected {
      border-color: var(--color-accent);
    }

    .ig-post-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-post-item .post-type-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .ig-post-item .post-type-badge svg {
      width: 10px;
      height: 10px;
    }

    .ig-post-item .post-select-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .ig-post-item .post-select-indicator.checked {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }

    .ig-post-item .post-select-indicator svg {
      width: 12px;
      height: 12px;
      color: transparent;
    }

    .ig-post-item .post-select-indicator.checked svg {
      color: white;
    }

    /* Highlights Grid */
    .ig-highlights-container {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .ig-highlight-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .ig-highlight-item:hover {
      transform: scale(1.05);
    }

    .ig-highlight-item .highlight-cover {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
    }

    .ig-highlight-item .highlight-cover img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }

    .ig-highlight-item .highlight-title {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-text);
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: center;
    }

    .ig-highlight-item .highlight-count {
      font-size: 0.6875rem;
      color: var(--color-text-light);
    }

    /* Downloaded Stories Grid */
    .stories-import-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .stories-import-header span {
      font-size: 0.875rem;
      color: var(--color-text-light);
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .ig-story-item {
      position: relative;
      aspect-ratio: 9/16;
      border-radius: 8px;
      overflow: hidden;
      background: var(--color-bg);
    }

    .ig-story-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-story-item .story-type-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .ig-story-item .story-type-badge svg {
      width: 10px;
      height: 10px;
    }

    .ig-story-item {
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.15s;
    }

    .ig-story-item.selected {
      border-color: var(--color-accent);
    }

    .ig-story-item .post-select-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .ig-story-item.selected .post-select-indicator {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }

    .ig-story-item .post-select-indicator svg {
      width: 12px;
      height: 12px;
      color: transparent;
    }

    .ig-story-item.selected .post-select-indicator svg {
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8125rem;
    }

    /* Stories Edit */
    .story-edit-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .story-edit-ring {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px solid var(--color-accent);
      padding: 2px;
      background: var(--color-white);
    }

    .story-edit-ring img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .story-edit-label {
      font-size: 0.75rem;
      color: var(--color-text-light);
    }

    .story-edit-empty {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px dashed var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-light);
    }

    @media (max-width: 1024px) {
      .editor-layout {
        grid-template-columns: 1fr;
      }
      .editor-sidebar {
        display: none;
      }
      .editor-main {
        padding: 24px;
      }
    }

    /* Sync Status Banner */
    .sync-banner {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #f5ebe4 0%, #fff4f0 100%);
      border-bottom: 1px solid var(--color-border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 99;
      font-size: 0.875rem;
    }

    .sync-banner.hidden {
      display: none;
    }

    .sync-banner .sync-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .sync-banner .sync-message {
      color: var(--color-text);
    }

    .sync-banner .sync-complete {
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sync-banner:not(.hidden) + .editor-layout {
      margin-top: 108px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Sync Status Banner -->
  <div id="syncBanner" class="sync-banner hidden">
    <div class="sync-spinner" id="syncSpinner"></div>
    <span class="sync-message" id="syncMessage">Syncing your Instagram content...</span>
  </div>
  <!-- Top Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <a href="index.html" class="back-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Back
      </a>
      <h1 class="top-bar-title" id="pageTitle">New Itinerary</h1>
    </div>
    <div class="top-bar-actions">
      <div class="completion-meter" id="completionMeter" title="Itinerary completeness">
        <span class="completion-meter-label">Quality</span>
        <div class="completion-meter-bar">
          <div class="completion-meter-fill" id="completionFill" style="width: 0%"></div>
        </div>
        <span class="completion-meter-percent" id="completionPercent">0%</span>
      </div>
      <button class="btn btn-outline" id="previewBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Preview
      </button>
      <button class="btn btn-primary" id="saveBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save
      </button>
    </div>
  </header>

  <div class="editor-layout">
    <main class="editor-main">
      <!-- Instagram Content -->
      <section class="form-section">
        <h2 class="form-section-title">Your Instagram Content</h2>
        <p class="form-hint" style="margin-bottom: 16px;">Sync your Instagram profile to import posts and stories for this itinerary.</p>

        <!-- Step 1: Profile Sync -->
        <div class="ig-import-section">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
            </svg>
            <h3>Step 1: Sync Your Profile</h3>
          </div>
          <div class="ig-import-body">
            <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
              <div style="position: relative; flex: 1; display: flex; align-items: center;">
                <span style="position: absolute; left: 12px; color: var(--color-text-light);">@</span>
                <input type="text" id="igProfileUrl" class="form-input" placeholder="Your verified Instagram" style="flex: 1; padding-left: 28px;">
                <span id="verifiedBadge" style="display: none; position: absolute; right: 12px; color: #28a745; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  Verified
                </span>
              </div>
              <button type="button" class="ig-import-btn secondary" id="loadSavedBtn" onclick="loadSavedPosts()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Load Saved
              </button>
              <button type="button" class="ig-import-btn" id="syncProfileBtn" onclick="syncInstagramProfile()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                </svg>
                Sync New
              </button>
            </div>
            <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 0.875rem; color: var(--color-text-light);">From:</label>
                <input type="date" id="igDateFrom" class="form-input" style="width: auto;">
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 0.875rem; color: var(--color-text-light);">To:</label>
                <input type="date" id="igDateTo" class="form-input" style="width: auto;">
              </div>
              <span style="font-size: 0.75rem; color: var(--color-text-light);">Load Saved = instant from database | Sync New = fetch from Instagram</span>
            </div>
            <span class="ig-import-status" id="syncProfileStatus"></span>

            <!-- Synced Posts Grid -->
            <div class="ig-posts-grid" id="igPostsGrid" style="display: none;">
              <p class="form-hint" style="margin-bottom: 12px;">Select posts to include in this itinerary:</p>
              <div class="ig-posts-container" id="igPostsContainer"></div>
              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllPosts()">Select All</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllPosts()">Clear All</button>
                <button type="button" class="ig-import-btn" id="importSelectedBtn" onclick="importSelectedPosts()" style="display: none;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Import Selected (<span id="selectedCount">0</span>)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Highlights/Stories -->
        <div class="ig-import-section" style="margin-top: 24px;">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <h3>Step 2: Import Story Highlights</h3>
          </div>
          <div class="ig-import-body">
            <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
              <button type="button" class="ig-import-btn secondary" id="loadSavedHighlightsBtn" onclick="loadSavedHighlights()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Load Saved
              </button>
              <select id="highlightsDateFilter" style="padding: 10px 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                <option value="all">All highlights</option>
                <option value="3months" selected>Last 3 months</option>
                <option value="6months">Last 6 months</option>
                <option value="1year">Last year</option>
              </select>
              <button type="button" class="ig-import-btn" id="getHighlightsBtn" onclick="getInstagramHighlights()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Sync New
              </button>
            </div>
            <span class="ig-import-status" id="highlightsStatus"></span>

            <!-- Highlights Grid -->
            <div class="ig-highlights-grid" id="igHighlightsGrid" style="display: none;">
              <p class="form-hint" style="margin-bottom: 12px;">Select a highlight to download its stories:</p>
              <div class="ig-highlights-container" id="igHighlightsContainer"></div>
            </div>

            <!-- Downloaded Stories -->
            <div class="ig-stories-grid" id="igStoriesGrid" style="display: none; margin-top: 16px;">
              <p class="form-hint" style="margin-bottom: 12px;">Stories from selected highlight:</p>
              <div class="ig-stories-container" id="igStoriesContainer"></div>
            </div>
          </div>
        </div>

        <!-- Imported Content Grid -->
        <div class="ig-import-section" style="margin-top: 24px;">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <h3>Imported Content</h3>
          </div>
          <div class="ig-import-body">
            <div class="ig-content-grid" id="igContentGrid">
              <div class="ig-content-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <p>Imported content will appear here</p>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- AI Generate Itinerary -->
      <section class="form-section" id="generateSection" style="background: linear-gradient(135deg, #f8f4ff 0%, #fff4f0 100%); border-radius: 12px; padding: 24px;">
        <h2 class="form-section-title" style="display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
            <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
            <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
          </svg>
          Generate Itinerary with AI
        </h2>
        <p class="form-hint" style="margin-bottom: 16px;">
          Import your content above, then let AI create a complete itinerary with title, introduction, and day-by-day organization.
        </p>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label" for="numDays">Number of Days</label>
            <input type="number" id="numDays" class="form-input" min="1" max="30" value="4" style="width: 100px;">
          </div>
          <div class="form-group" style="flex: 2;">
            <label class="form-label" for="tripContext">Trip Context (optional)</label>
            <input type="text" id="tripContext" class="form-input" placeholder="e.g., Safari honeymoon, Family adventure, Solo backpacking...">
          </div>
        </div>

        <div style="display: flex; align-items: center; gap: 16px;">
          <button type="button" class="ig-import-btn" id="generateItineraryBtn" onclick="generateItineraryWithAI()" style="font-size: 1rem; padding: 14px 28px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
              <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
              <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
            </svg>
            Generate Itinerary
          </button>
          <span id="generateStatus" class="ig-import-status"></span>
        </div>
        <p class="form-hint" style="margin-top: 12px;">
          <strong>Imported content:</strong> <span id="importedContentCount">0</span> items ready
        </p>
      </section>

      <!-- Trip Info -->
      <section class="form-section">
        <h2 class="form-section-title">Trip Information</h2>

        <div class="form-group">
          <label class="form-label" for="title">Title</label>
          <input type="text" id="title" class="form-input" placeholder="e.g., Wilderness & Wonder">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="destination">Destination</label>
            <input type="text" id="destination" class="form-input" placeholder="e.g., Namibia">
          </div>
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input type="text" id="location" class="form-input" placeholder="e.g., Onguma, Etosha">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="duration">Duration</label>
            <input type="text" id="duration" class="form-input" placeholder="e.g., 4 days / 3 nights">
          </div>
          <div class="form-group">
            <label class="form-label" for="priceFrom">From Price (per person)</label>
            <div style="position: relative;">
              <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-light);">$</span>
              <input type="number" id="priceFrom" class="form-input" placeholder="Auto-calculated from stays" style="padding-left: 24px;">
            </div>
            <p class="form-hint">Leave blank to auto-calculate from property prices.</p>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="intro">Introduction</label>
          <div class="textarea-wrapper">
            <textarea id="intro" class="form-textarea" rows="4" placeholder="Write a personal introduction to this itinerary..." style="padding-right: 48px;"></textarea>
            <button type="button" class="ai-wand-btn" onclick="toggleAiMenu(this)" title="AI Enhance">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>
            </button>
            <div class="ai-menu">
              <div class="ai-menu-header">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M15 9h0M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/></svg>
                AI Enhance
              </div>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'improve')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                Improve Writing
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'shorten')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 12H7"/><path d="m11 8-4 4 4 4"/><path d="m13 8 4 4-4 4"/></svg>
                Make Shorter
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'expand')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12H3"/><path d="m15 6 6 6-6 6"/><path d="m9 6-6 6 6 6"/></svg>
                Expand & Add Detail
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'personal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                More Personal
              </button>
            </div>
          </div>
          <p class="form-hint">Tell travelers why you love this destination and what makes it special.</p>
        </div>

        <div class="form-group">
          <label class="form-label" for="whyCurated">Why I curated this trip</label>
          <textarea id="whyCurated" class="form-textarea" rows="4" placeholder="Share your personal connection to this trip - what made it special, why you want others to experience it..."></textarea>
          <p class="form-hint">This quote appears prominently on your itinerary page, giving travelers insight into your personal experience.</p>
        </div>
      </section>

      <!-- Stays / Properties -->
      <section class="form-section">
        <h2 class="form-section-title">Where You Stayed</h2>
        <p class="form-hint" style="margin-bottom: 16px;">Add the properties/lodges you stayed at during this trip. AI will generate descriptions and find images.</p>

        <div id="staysList" class="stays-list">
          <!-- Stays will be added here -->
        </div>

        <button type="button" class="add-day-btn" id="addStayBtn" onclick="addStay()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Property
        </button>
      </section>

      <!-- Hero Image -->
      <section class="form-section">
        <h2 class="form-section-title">Hero Image</h2>
        <div id="heroImageContainer">
          <div class="hero-upload" id="heroUpload">
            <div class="hero-upload-content">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              <p>Click to upload or drag image here</p>
              <p class="form-hint">Recommended: 1920x1080px</p>
            </div>
            <input type="file" accept="image/*" id="heroInput">
          </div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Or paste image URL</label>
          <div style="display: flex; gap: 8px;">
            <input type="url" id="heroUrl" class="form-input" placeholder="https://...">
            <button type="button" class="btn btn-outline" onclick="loadHeroFromUrl()" style="white-space: nowrap;">Load URL</button>
          </div>
        </div>
      </section>

      <!-- Day-by-Day -->
      <section class="form-section">
        <h2 class="form-section-title">Day-by-Day Itinerary</h2>

        <div class="days-list" id="daysList">
          <!-- Day cards will be added here -->
        </div>

        <button class="add-day-btn" id="addDayBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Day
        </button>
      </section>

      <!-- Gallery -->
      <section class="form-section">
        <h2 class="form-section-title">Gallery</h2>
        <p class="form-hint" style="margin-bottom: 12px;">Optional: Upload additional images here. Instagram posts and stories are displayed separately.</p>
        <div class="gallery-grid" id="galleryGrid">
          <!-- Gallery items will be added here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="addGalleryItem()" style="margin-top: 12px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Image
        </button>
      </section>
    </main>

    <aside class="editor-sidebar">
      <!-- Status -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Status</h3>
        <div class="status-toggle" style="flex-direction: column; gap: 8px;">
          <button class="status-option active" data-status="draft" style="flex: none;">Draft</button>
          <button class="status-option" data-status="pending" style="flex: none;">Submit for Approval</button>
        </div>
        <p class="form-hint" style="margin-top: 8px;">Itineraries require admin approval before going live.</p>
      </div>

      <!-- Best For -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Best For</h3>
        <div class="tags-input" id="bestForTags">
          <input type="text" placeholder="Add tag...">
        </div>
        <p class="form-hint" style="margin-top: 8px;">e.g., First safari, Photography, Couples</p>
      </div>

      <!-- Preview -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Preview</h3>
        <div class="preview-card">
          <div class="preview-card-image" id="previewImage">
            <img src="" alt="" style="display: none;">
          </div>
          <div class="preview-card-content">
            <h4 id="previewTitle">Untitled Itinerary</h4>
            <p id="previewMeta">Destination - Duration</p>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <span id="toastMessage">Saved successfully</span>
  </div>

  <script src="data.js"></script>
  <script>
    // Check auth
    const session = localStorage.getItem('juno_creator_session');
    if (!session) {
      // Allow access for demo purposes
      // window.location.href = 'login.html';
    }

    // State
    let itineraryData = {
      id: '',
      title: '',
      destination: '',
      location: '',
      duration: '',
      priceFrom: 0,
      intro: '',
      whyCurated: '',
      heroImage: '',
      days: [],
      included: [],
      bestFor: [],
      bestTimeToVisit: {
        peakWildlife: '',
        bestWeather: ''
      },
      status: 'draft'
    };

    // Instagram sync state (declared early to avoid temporal dead zone)
    let syncedPosts = [];
    let selectedPostIds = new Set();
    let highlights = [];
    let downloadedStories = [];
    let selectedStoryIndices = new Set();
    let importedPosts = [];
    let importedStories = [];
    let galleryItems = [];

    let currentStatus = 'draft';

    // ============================================
    // COMPLETION METER
    // ============================================
    function calculateCompletion() {
      let score = 0;
      let maxScore = 0;

      // Required fields (weighted)
      const checks = [
        { weight: 15, check: () => document.getElementById('title')?.value?.trim().length > 0 },
        { weight: 10, check: () => document.getElementById('destination')?.value?.trim().length > 0 },
        { weight: 10, check: () => document.getElementById('duration')?.value?.trim().length > 0 },
        { weight: 15, check: () => document.getElementById('intro')?.value?.trim().length > 50 },
        { weight: 10, check: () => document.getElementById('whyCurated')?.value?.trim().length > 20 },
        { weight: 10, check: () => itineraryData.heroImage?.length > 0 },
        { weight: 15, check: () => itineraryData.days?.length >= 2 },
        { weight: 5, check: () => importedPosts?.length >= 3 },
        { weight: 5, check: () => importedStories?.length >= 1 },
        { weight: 5, check: () => document.getElementById('priceFrom')?.value > 0 },
      ];

      checks.forEach(item => {
        maxScore += item.weight;
        if (item.check()) {
          score += item.weight;
        }
      });

      return Math.round((score / maxScore) * 100);
    }

    function updateCompletionMeter() {
      const percent = calculateCompletion();
      const fill = document.getElementById('completionFill');
      const percentEl = document.getElementById('completionPercent');

      if (!fill || !percentEl) return;

      fill.style.width = percent + '%';
      percentEl.textContent = percent + '%';

      // Update colors based on level
      fill.classList.remove('low', 'medium', 'high');
      percentEl.classList.remove('low', 'medium', 'high');

      if (percent < 40) {
        fill.classList.add('low');
        percentEl.classList.add('low');
      } else if (percent < 70) {
        fill.classList.add('medium');
        percentEl.classList.add('medium');
      } else {
        fill.classList.add('high');
        percentEl.classList.add('high');
      }
    }

    // Update completion meter on input changes
    document.addEventListener('input', (e) => {
      if (e.target.closest('.editor-main')) {
        updateCompletionMeter();
      }
    });

    // Also update when days/content changes
    const originalPushDay = Array.prototype.push;

    // Elements
    const daysList = document.getElementById('daysList');
    const addDayBtn = document.getElementById('addDayBtn');
    const heroUpload = document.getElementById('heroUpload');
    const heroInput = document.getElementById('heroInput');
    const saveBtn = document.getElementById('saveBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    // Sync banner elements
    const syncBanner = document.getElementById('syncBanner');
    const syncSpinner = document.getElementById('syncSpinner');
    const syncMessage = document.getElementById('syncMessage');

    // Auto-fill verified Instagram
    // TODO: Re-enable lock after testing - remove editable flag
    const TESTING_MODE = true; // Set to false to lock Instagram input
    const sessionData = session ? JSON.parse(session) : null;
    const verifiedInstagram = sessionData?.instagram || localStorage.getItem('juno_verified_instagram') ? JSON.parse(localStorage.getItem('juno_verified_instagram') || '{}').username : null;

    if (verifiedInstagram) {
      const igProfileInput = document.getElementById('igProfileUrl');
      const verifiedBadge = document.getElementById('verifiedBadge');
      igProfileInput.value = verifiedInstagram;

      if (!TESTING_MODE) {
        // Lock the input in production
        igProfileInput.readOnly = true;
        igProfileInput.style.backgroundColor = '#f0fdf4';
        igProfileInput.style.borderColor = '#86efac';
        igProfileInput.style.cursor = 'not-allowed';
        igProfileInput.title = 'Verified Instagram account (cannot be changed)';
        if (verifiedBadge) {
          verifiedBadge.style.display = 'flex';
        }
      } else {
        // Testing mode - allow editing
        igProfileInput.title = 'Testing mode: You can change this';
      }
    }

    // Check and display sync status on page load
    checkSyncStatus();

    async function checkSyncStatus() {
      const session = JSON.parse(localStorage.getItem('juno_creator_session') || '{}');
      const creatorId = session.creatorId;
      const syncStatus = session.sync_status;

      // If not logged in or already completed, don't show banner
      if (!creatorId || syncStatus === 'completed') {
        return;
      }

      // If syncing, show banner and start polling
      if (syncStatus === 'syncing') {
        showSyncBanner('Syncing your Instagram content...');
        pollSyncStatus();
        return;
      }

      // If pending and there's an Instagram handle, we might need to start sync
      if (syncStatus === 'pending' && session.instagram) {
        // Check if sync was started elsewhere
        if (window.SUPABASE_CONFIGURED) {
          try {
            const status = await JunoDB.getCreatorSyncStatus(creatorId);
            if (status && status.sync_status === 'syncing') {
              session.sync_status = 'syncing';
              localStorage.setItem('juno_creator_session', JSON.stringify(session));
              showSyncBanner('Syncing your Instagram content...');
              pollSyncStatus();
            } else if (status && status.sync_status === 'completed') {
              session.sync_status = 'completed';
              session.last_synced_at = status.last_synced_at;
              localStorage.setItem('juno_creator_session', JSON.stringify(session));
            }
          } catch (e) {
            console.error('Error checking sync status:', e);
          }
        }
      }
    }

    function showSyncBanner(message) {
      syncBanner.classList.remove('hidden');
      syncMessage.textContent = message;
      syncSpinner.style.display = 'block';
    }

    function hideSyncBanner() {
      syncBanner.classList.add('hidden');
    }

    function showSyncComplete() {
      syncSpinner.style.display = 'none';
      syncMessage.innerHTML = '<span class="sync-complete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Instagram content synced! Click "Load Saved" to use your posts and highlights.</span>';

      // Hide banner after 5 seconds
      setTimeout(() => {
        hideSyncBanner();
      }, 5000);
    }

    async function pollSyncStatus() {
      const session = JSON.parse(localStorage.getItem('juno_creator_session') || '{}');
      const creatorId = session.creatorId;

      if (!creatorId || !window.SUPABASE_CONFIGURED) {
        return;
      }

      let attempts = 0;
      const maxAttempts = 60; // 5 minutes max (5s interval)

      const poll = async () => {
        attempts++;

        try {
          const status = await JunoDB.getCreatorSyncStatus(creatorId);

          if (status && status.sync_status === 'completed') {
            // Update session
            session.sync_status = 'completed';
            session.last_synced_at = status.last_synced_at;
            localStorage.setItem('juno_creator_session', JSON.stringify(session));

            showSyncComplete();
            showToast('Instagram content synced successfully!', 'success');
            return;
          }

          if (status && status.sync_status === 'failed') {
            session.sync_status = 'failed';
            localStorage.setItem('juno_creator_session', JSON.stringify(session));
            hideSyncBanner();
            showToast('Sync failed. Try "Sync New" to retry.', 'error');
            return;
          }

          // Still syncing - update message with progress
          const elapsed = attempts * 5;
          syncMessage.textContent = `Syncing your Instagram content... (${elapsed}s)`;

          // Continue polling if not exceeded max attempts
          if (attempts < maxAttempts) {
            setTimeout(poll, 5000);
          } else {
            hideSyncBanner();
            showToast('Sync is taking longer than expected. Check back later.');
          }
        } catch (error) {
          console.error('Error polling sync status:', error);
          if (attempts < maxAttempts) {
            setTimeout(poll, 5000);
          }
        }
      };

      // Start polling after initial delay
      setTimeout(poll, 5000);
    }

    // Load existing itinerary if editing
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    if (editId && ITINERARIES[editId]) {
      loadItinerary(ITINERARIES[editId]);
      document.getElementById('pageTitle').textContent = ITINERARIES[editId].title || 'Edit Itinerary';
    } else {
      // Add first day by default
      addDay();
    }

    // Initial completion meter update
    setTimeout(updateCompletionMeter, 100);

    function loadItinerary(data) {
      itineraryData = { ...data };

      document.getElementById('title').value = data.title || '';
      document.getElementById('destination').value = data.destination || '';
      document.getElementById('location').value = data.location || '';
      document.getElementById('duration').value = data.duration || '';
      document.getElementById('intro').value = data.intro || '';
      document.getElementById('whyCurated').value = data.whyCurated || data.why_curated || '';

      // Hero image
      if (data.heroImage) {
        setHeroImage(data.heroImage);
      }

      // Status
      setStatus(data.status || 'draft');

      // Best For tags
      if (data.bestFor) {
        data.bestFor.forEach(tag => addTag('bestForTags', tag));
      }

      // Stays/Properties
      if (data.stays && data.stays.length > 0) {
        data.stays.forEach(stay => addStay(stay));
      }

      // Days
      if (data.days && data.days.length > 0) {
        data.days.forEach(day => addDay(day));
      }

      // Instagram content (posts and stories)
      if (data.posts || data.stories) {
        loadImportedContent({ posts: data.posts, stories: data.stories });
      }

      updatePreview();
      updateStoriesPreview();
    }

    // Update Stories Preview (section was removed, but keep function for compatibility)
    function updateStoriesPreview() {
      const storiesList = document.getElementById('storiesList');
      if (!storiesList) return; // Section was removed
      const days = Array.from(daysList.children);

      let html = '';
      days.forEach((dayCard, i) => {
        const dayNum = i + 1;
        const mediaItems = dayCard.querySelectorAll('.media-item:not(.media-item-add) img');
        const firstMedia = mediaItems.length > 0 ? mediaItems[0].src : null;

        if (firstMedia) {
          html += `
            <div class="story-edit-item">
              <div class="story-edit-ring">
                <img src="${firstMedia}" alt="Day ${dayNum}">
              </div>
              <span class="story-edit-label">Day ${dayNum}</span>
            </div>
          `;
        } else {
          html += `
            <div class="story-edit-item">
              <div class="story-edit-empty">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              </div>
              <span class="story-edit-label">Day ${dayNum}</span>
            </div>
          `;
        }
      });

      storiesList.innerHTML = html || '<p style="color: var(--color-text-light);">Add days and media below to see story previews</p>';
    }

    // Add Day
    function addDay(dayData = null) {
      const dayNum = daysList.children.length + 1;
      const day = dayData || {
        dayNumber: dayNum,
        title: '',
        description: '',
        activities: [],
        media: []
      };

      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.dataset.dayNum = dayNum;
      dayCard.innerHTML = `
        <div class="day-card-header">
          <h3>
            <span class="day-number">${dayNum}</span>
            <input type="text" class="form-input" style="border: none; padding: 0; font-weight: 500;" placeholder="Day title..." value="${day.title || ''}">
          </h3>
          <div class="day-card-actions">
            <button class="icon-btn" onclick="toggleDayCard(this)" title="Collapse">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <button class="icon-btn" onclick="removeDay(this)" title="Remove">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
        <div class="day-card-content">
          <div class="form-group">
            <label class="form-label">Description</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea day-description" rows="4" placeholder="Describe this day from your personal experience..." style="padding-right: 48px;">${day.description || ''}</textarea>
              <button type="button" class="ai-wand-btn" onclick="toggleAiMenu(this)" title="AI Enhance">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>
              </button>
              <div class="ai-menu">
                <div class="ai-menu-header">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M15 9h0M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/></svg>
                  AI Enhance
                </div>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'improve')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                  Improve Writing
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'shorten')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 12H7"/><path d="m11 8-4 4 4 4"/><path d="m13 8 4 4-4 4"/></svg>
                  Make Shorter
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'expand')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12H3"/><path d="m15 6 6 6-6 6"/><path d="m9 6-6 6 6 6"/></svg>
                  Expand & Add Detail
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'personal')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                  More Personal
                </button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Activities</label>
            <input type="text" class="form-input day-activities" placeholder="e.g., Morning Game Drive, Pool, Sundowners" value="${(day.activities || []).join(', ')}">
          </div>
        </div>
      `;

      daysList.appendChild(dayCard);
      updateStoriesPreview();
    }

    function toggleDayCard(btn) {
      const card = btn.closest('.day-card');
      const content = card.querySelector('.day-card-content');
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
      btn.querySelector('svg').style.transform = content.style.display === 'none' ? 'rotate(-90deg)' : '';
    }

    function removeDay(btn) {
      if (daysList.children.length <= 1) {
        showToast('You need at least one day');
        return;
      }
      btn.closest('.day-card').remove();
      // Renumber days
      Array.from(daysList.children).forEach((card, i) => {
        card.dataset.dayNum = i + 1;
        card.querySelector('.day-number').textContent = i + 1;
      });
      updateStoriesPreview();
    }

    addDayBtn.addEventListener('click', () => {
      addDay();
      updateCompletionMeter();
    });

    // Hero Image
    const heroContainer = document.getElementById('heroImageContainer');
    heroInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => setHeroImage(e.target.result);
        reader.readAsDataURL(file);
      }
    });

    function setHeroImage(src, focalX = 50, focalY = 50) {
      heroContainer.innerHTML = `
        <div class="hero-preview" id="heroPreviewContainer">
          <img src="${src}" alt="Hero" style="object-position: ${focalX}% ${focalY}%;" id="heroImg">
          <div class="hero-focal-point" id="heroFocalPoint" style="left: ${focalX}%; top: ${focalY}%;" title="Drag to adjust focal point">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
          </div>
          <div class="hero-focal-hint">Drag crosshair to set focal point</div>
          <div class="hero-preview-actions">
            <button type="button" class="hero-preview-btn" onclick="changeHeroImage()" title="Change Image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>
            <button type="button" class="hero-preview-btn" onclick="removeHeroImage()" title="Remove Image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
      `;
      itineraryData.heroImage = src;
      itineraryData.heroFocalX = focalX;
      itineraryData.heroFocalY = focalY;
      updatePreview();
      initHeroFocalDrag();
      updateCompletionMeter();
    }

    function initHeroFocalDrag() {
      const container = document.getElementById('heroPreviewContainer');
      const focalPoint = document.getElementById('heroFocalPoint');
      const heroImg = document.getElementById('heroImg');
      if (!container || !focalPoint) return;

      let isDragging = false;

      const updateFocalPoint = (e) => {
        const rect = container.getBoundingClientRect();
        let x = ((e.clientX - rect.left) / rect.width) * 100;
        let y = ((e.clientY - rect.top) / rect.height) * 100;

        // Clamp values
        x = Math.max(0, Math.min(100, x));
        y = Math.max(0, Math.min(100, y));

        focalPoint.style.left = x + '%';
        focalPoint.style.top = y + '%';
        heroImg.style.objectPosition = `${x}% ${y}%`;

        itineraryData.heroFocalX = x;
        itineraryData.heroFocalY = y;
      };

      focalPoint.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.preventDefault();
      });

      container.addEventListener('click', (e) => {
        if (e.target.closest('.hero-preview-actions')) return;
        updateFocalPoint(e);
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          updateFocalPoint(e);
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }

    function changeHeroImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => setHeroImage(e.target.result);
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function removeHeroImage() {
      heroContainer.innerHTML = `
        <div class="hero-upload" id="heroUpload">
          <div class="hero-upload-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            <p>Click to upload or drag image here</p>
            <p class="form-hint">Recommended: 1920x1080px</p>
          </div>
          <input type="file" accept="image/*" id="heroInput">
        </div>
      `;
      document.getElementById('heroInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => setHeroImage(ev.target.result);
          reader.readAsDataURL(file);
        }
      });
      itineraryData.heroImage = '';
      updatePreview();
    }

    function loadHeroFromUrl() {
      const url = document.getElementById('heroUrl').value.trim();
      if (!url) {
        showToast('Please enter an image URL');
        return;
      }
      // Test if URL is valid image
      const img = new Image();
      img.onload = () => {
        setHeroImage(url);
        document.getElementById('heroUrl').value = '';
        showToast('Image loaded successfully', 'success');
      };
      img.onerror = () => {
        showToast('Could not load image from URL');
      };
      img.src = url;
    }

    // Stays / Properties
    const staysList = document.getElementById('staysList');

    function addStay(stayData = null) {
      const stay = stayData || { name: '', location: '', description: '', images: [] };
      const stayItem = document.createElement('div');
      stayItem.className = 'stay-item';
      const stayId = 'stay-' + Date.now();
      stayItem.dataset.stayId = stayId;

      // Build images HTML
      const imagesHtml = (stay.images || []).map((img, idx) => `
        <div class="stay-gallery-item" data-url="${img}">
          <img src="${img}" alt="Property image">
          <button type="button" class="stay-gallery-remove" onclick="this.parentElement.remove()"></button>
        </div>
      `).join('');

      stayItem.innerHTML = `
        <div class="stay-item-fields">
          <div style="display: flex; gap: 12px; align-items: flex-start;">
            <div style="flex: 1;">
              <input type="text" class="form-input stay-name" placeholder="Property name (e.g., Maison d'Htes au Fil du Fleuve)" value="${stay.name || ''}" style="margin-bottom: 8px;">
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-input stay-location" placeholder="Location (e.g., Saint Louis, Senegal)" value="${stay.location || ''}" style="flex: 2;">
                <div style="flex: 1; position: relative;">
                  <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--color-text-light);">$</span>
                  <input type="number" class="form-input stay-price" placeholder="per night" value="${stay.price_per_night || ''}" style="padding-left: 24px;">
                </div>
              </div>
            </div>
            <button type="button" class="icon-btn" onclick="this.closest('.stay-item').remove()" title="Remove">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>

          <div style="margin-top: 12px;">
            <label class="form-label" style="font-size: 0.875rem;">Your thoughts on this property</label>
            <textarea class="form-textarea stay-description" rows="3" placeholder="Share your personal experience - what made this place special, the vibe, the service, why you'd recommend it...">${stay.description || ''}</textarea>
          </div>

          <div style="margin-top: 12px;">
            <label class="form-label" style="font-size: 0.875rem;">Property Photos</label>
            <div class="stay-gallery" id="${stayId}-gallery">
              ${imagesHtml}
              <div class="stay-gallery-add" onclick="addStayImage('${stayId}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Add Photo</span>
              </div>
            </div>
          </div>
        </div>
      `;
      staysList.appendChild(stayItem);

      // Add event listener for price changes
      const priceInput = stayItem.querySelector('.stay-price');
      priceInput.addEventListener('input', updateCalculatedPrice);
    }

    // Calculate and suggest price based on stays
    function updateCalculatedPrice() {
      const priceFromInput = document.getElementById('priceFrom');
      const durationInput = document.getElementById('duration');
      const duration = durationInput.value || '';

      // Only auto-update if the price field is empty (not manually set)
      if (priceFromInput.value) return;

      // Extract number of nights from duration
      const nightsMatch = duration.match(/(\d+)\s*nights?/i) || duration.match(/(\d+)\s*days?/i);
      let numNights = 0;
      if (nightsMatch) {
        numNights = parseInt(nightsMatch[1]);
        // If it says "days" not "nights", subtract 1
        if (duration.includes('days') && !duration.includes('nights')) {
          numNights = numNights - 1;
        }
      }

      // Gather stay prices
      const stayPrices = Array.from(document.querySelectorAll('.stay-price'))
        .map(input => parseFloat(input.value) || 0)
        .filter(price => price > 0);

      if (stayPrices.length > 0 && numNights > 0) {
        const avgNightlyRate = stayPrices.reduce((sum, p) => sum + p, 0) / stayPrices.length;
        const calculatedPrice = Math.round(avgNightlyRate * numNights);
        priceFromInput.placeholder = `~$${calculatedPrice.toLocaleString()} (auto-calculated)`;
      } else if (stayPrices.length > 0) {
        priceFromInput.placeholder = 'Enter duration to calculate';
      } else {
        priceFromInput.placeholder = 'Auto-calculated from stays';
      }
    }

    // Also update when duration changes
    document.getElementById('duration').addEventListener('input', updateCalculatedPrice);

    function addStayImage(stayId) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const gallery = document.getElementById(`${stayId}-gallery`);
        const addBtn = gallery.querySelector('.stay-gallery-add');

        // Show loading state
        addBtn.innerHTML = '<span class="spinner"></span>';

        try {
          // Upload to Cloudinary
          const formData = new FormData();
          formData.append('file', file);
          formData.append('upload_preset', 'juno_unsigned');

          const response = await fetch('https://api.cloudinary.com/v1_1/dyuv2u8ru/image/upload', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.secure_url) {
            const imgItem = document.createElement('div');
            imgItem.className = 'stay-gallery-item';
            imgItem.dataset.url = data.secure_url;
            imgItem.innerHTML = `
              <img src="${data.secure_url}" alt="Property image">
              <button type="button" class="stay-gallery-remove" onclick="this.parentElement.remove()"></button>
            `;
            gallery.insertBefore(imgItem, addBtn);
          }
        } catch (err) {
          console.error('Upload error:', err);
          showToast('Failed to upload image', 'error');
        }

        // Reset add button
        addBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          <span>Add Photo</span>
        `;
      };
      input.click();
    }

    // Tags
    function addTag(containerId, tagText) {
      const container = document.getElementById(containerId);
      const input = container.querySelector('input');
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.innerHTML = `${tagText} <button onclick="this.parentElement.remove()">&times;</button>`;
      container.insertBefore(tag, input);
    }

    document.getElementById('bestForTags').querySelector('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        addTag('bestForTags', e.target.value.trim());
        e.target.value = '';
      }
    });

    // Status toggle
    document.querySelectorAll('.status-option').forEach(btn => {
      btn.addEventListener('click', () => setStatus(btn.dataset.status));
    });

    function setStatus(status) {
      currentStatus = status;
      document.querySelectorAll('.status-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === status);
      });
    }

    // Preview updates
    ['title', 'destination', 'duration'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePreview);
    });

    function updatePreview() {
      const title = document.getElementById('title').value || 'Untitled Itinerary';
      const destination = document.getElementById('destination').value || 'Destination';
      const duration = document.getElementById('duration').value || 'Duration';

      document.getElementById('previewTitle').textContent = title;
      document.getElementById('previewMeta').textContent = `${destination} - ${duration}`;

      const previewImg = document.querySelector('#previewImage img');
      if (itineraryData.heroImage) {
        previewImg.src = itineraryData.heroImage;
        previewImg.style.display = 'block';
      }
    }

    // Media
    function addMedia(btn) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const mediaItem = document.createElement('div');
            mediaItem.className = 'media-item';
            mediaItem.innerHTML = `
              <img src="${e.target.result}" alt="">
              <div class="media-item-remove" onclick="removeMedia(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </div>
            `;
            btn.parentElement.insertBefore(mediaItem, btn);
            updateStoriesPreview();
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function removeMedia(btn) {
      btn.closest('.media-item').remove();
      updateStoriesPreview();
    }

    // Gallery functions
    function addGalleryItem(imageUrl = null, isVideo = false) {
      const grid = document.getElementById('galleryGrid');

      if (imageUrl) {
        // Add from URL (e.g., from imported content)
        const item = document.createElement('div');
        item.className = 'gallery-item' + (isVideo ? ' gallery-item-video' : '');
        item.innerHTML = `
          <img src="${imageUrl}" alt="">
          <div class="gallery-item-remove" onclick="removeGalleryItem(this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </div>
        `;
        grid.appendChild(item);
      } else {
        // Add from file picker
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,video/*';
        input.multiple = true;
        input.onchange = (e) => {
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
              const item = document.createElement('div');
              item.className = 'gallery-item' + (file.type.startsWith('video') ? ' gallery-item-video' : '');
              item.innerHTML = `
                <img src="${ev.target.result}" alt="">
                <div class="gallery-item-remove" onclick="removeGalleryItem(this)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </div>
              `;
              grid.appendChild(item);
            };
            reader.readAsDataURL(file);
          });
        };
        input.click();
      }
    }

    function removeGalleryItem(btn) {
      btn.closest('.gallery-item').remove();
    }

    function clearGallery() {
      document.getElementById('galleryGrid').innerHTML = '';
    }

    function populateGallery(items) {
      clearGallery();
      items.forEach(item => {
        addGalleryItem(item.url || item.thumbnail_url, item.type === 'video' || item.type === 'Video');
      });
    }

    // Save
    saveBtn.addEventListener('click', async () => {
      // Gather data
      itineraryData.title = document.getElementById('title').value?.trim() || '';
      itineraryData.destination = document.getElementById('destination').value?.trim() || '';
      itineraryData.location = document.getElementById('location').value?.trim() || '';
      itineraryData.duration = document.getElementById('duration').value?.trim() || '';
      itineraryData.priceFrom = parseFloat(document.getElementById('priceFrom').value) || null;
      itineraryData.intro = document.getElementById('intro').value?.trim() || '';
      itineraryData.whyCurated = document.getElementById('whyCurated').value?.trim() || '';
      itineraryData.status = currentStatus;

      // Validate required fields
      if (!itineraryData.title) {
        showToast('Please enter a title for your itinerary', 'error');
        document.getElementById('title').focus();
        return;
      }

      // Gather stays
      itineraryData.stays = Array.from(staysList.children).map(item => {
        const images = Array.from(item.querySelectorAll('.stay-gallery-item')).map(img => img.dataset.url);
        return {
          name: item.querySelector('.stay-name')?.value || '',
          location: item.querySelector('.stay-location')?.value || '',
          description: item.querySelector('.stay-description')?.value || '',
          price_per_night: parseFloat(item.querySelector('.stay-price')?.value) || null,
          images: images
        };
      }).filter(s => s.name);

      // Auto-calculate price_from if not set but stays have prices
      if (!itineraryData.priceFrom && itineraryData.stays.length > 0) {
        const staysWithPrices = itineraryData.stays.filter(s => s.price_per_night > 0);
        if (staysWithPrices.length > 0) {
          // Extract number of nights from duration
          const nightsMatch = itineraryData.duration.match(/(\d+)\s*nights?/i) || itineraryData.duration.match(/(\d+)\s*days?/i);
          let numNights = 0;
          if (nightsMatch) {
            numNights = parseInt(nightsMatch[1]);
            if (itineraryData.duration.includes('days') && !itineraryData.duration.includes('nights')) {
              numNights = numNights - 1;
            }
          }
          if (numNights > 0) {
            const avgNightlyRate = staysWithPrices.reduce((sum, s) => sum + s.price_per_night, 0) / staysWithPrices.length;
            itineraryData.priceFrom = Math.round(avgNightlyRate * numNights);
          }
        }
      }

      // Best for tags
      itineraryData.bestFor = Array.from(document.querySelectorAll('#bestForTags .tag'))
        .map(t => t.textContent.trim().replace('', '').trim());

      // Days
      itineraryData.days = Array.from(daysList.children).map((card, i) => ({
        dayNumber: i + 1,
        title: card.querySelector('.day-card-header input')?.value || '',
        description: card.querySelector('.day-description')?.value || '',
        activities: (card.querySelector('.day-activities')?.value || '').split(',').map(a => a.trim()).filter(a => a),
        media: Array.from(card.querySelectorAll('.media-item:not(.media-item-add) img'))
          .map(img => ({ type: 'image', url: img.src }))
      }));

      // Get creator ID from session
      const creatorId = getCreatorId();
      if (!creatorId) {
        showToast('You must be logged in to save', 'error');
        return;
      }

      // Show saving state
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        // Save to Supabase
        const response = await fetch('/.netlify/functions/save-itinerary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: itineraryData.id || null,
            creator_id: creatorId,
            title: itineraryData.title,
            destination: itineraryData.destination,
            region: itineraryData.location, // location maps to region
            duration: itineraryData.duration,
            price_from: itineraryData.priceFrom,
            hero_image: itineraryData.heroImage || null,
            intro: itineraryData.intro,
            why_curated: itineraryData.whyCurated,
            days: itineraryData.days,
            stays: itineraryData.stays,
            posts: getPostsForSave(),
            stories: getStoriesForSave(),
            included: itineraryData.included,
            status: itineraryData.status
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update local ID if it was generated
          if (result.itinerary?.id) {
            itineraryData.id = result.itinerary.id;
          }

          // Also save to localStorage as backup
          const savedItineraries = JSON.parse(localStorage.getItem('juno_itineraries') || '{}');
          savedItineraries[itineraryData.id] = itineraryData;
          localStorage.setItem('juno_itineraries', JSON.stringify(savedItineraries));

          showToast('Itinerary saved successfully!', 'success');
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to save: ' + error.message, 'error');
      } finally {
        // Restore button
        saveBtn.disabled = false;
        saveBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        `;
      }
    });

    // Preview button - shows modal preview without requiring save
    document.getElementById('previewBtn').addEventListener('click', () => {
      showPreviewModal();
    });

    // AI Wand Functions
    function toggleAiMenu(btn) {
      // Close all other menus
      document.querySelectorAll('.ai-menu.show').forEach(menu => {
        if (menu !== btn.nextElementSibling) {
          menu.classList.remove('show');
        }
      });
      // Toggle this menu
      const menu = btn.nextElementSibling;
      menu.classList.toggle('show');
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.textarea-wrapper')) {
        document.querySelectorAll('.ai-menu.show').forEach(menu => {
          menu.classList.remove('show');
        });
      }
    });

    async function enhanceText(btn, action) {
      const wrapper = btn.closest('.textarea-wrapper');
      const textarea = wrapper.querySelector('textarea');
      const wandBtn = wrapper.querySelector('.ai-wand-btn');
      const menu = wrapper.querySelector('.ai-menu');
      const originalText = textarea.value.trim();

      if (!originalText) {
        showToast('Please enter some text first');
        menu.classList.remove('show');
        return;
      }

      // Show loading state
      wandBtn.classList.add('loading');
      wandBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';
      menu.classList.remove('show');

      // Simulate AI processing (replace with actual API call later)
      await new Promise(resolve => setTimeout(resolve, 1500));

      let enhancedText = originalText;

      // Demo transformations (will be replaced with real AI)
      switch (action) {
        case 'improve':
          enhancedText = improveWriting(originalText);
          break;
        case 'shorten':
          enhancedText = shortenText(originalText);
          break;
        case 'expand':
          enhancedText = expandText(originalText);
          break;
        case 'personal':
          enhancedText = makePersonal(originalText);
          break;
      }

      // Update textarea with animation
      textarea.style.opacity = '0.5';
      setTimeout(() => {
        textarea.value = enhancedText;
        textarea.style.opacity = '1';
      }, 150);

      // Reset button
      wandBtn.classList.remove('loading');
      wandBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>';

      showToast('Text enhanced!', 'success');
    }

    // Demo text transformations (placeholders for real AI)
    function improveWriting(text) {
      // Simple demo: capitalize first letter of sentences, clean up spacing
      return text
        .split('. ')
        .map(s => s.charAt(0).toUpperCase() + s.slice(1))
        .join('. ')
        .replace(/\s+/g, ' ')
        .trim() + (text.endsWith('.') ? '' : '.');
    }

    function shortenText(text) {
      // Demo: take first 60% of text
      const sentences = text.split('. ');
      const keep = Math.max(1, Math.ceil(sentences.length * 0.6));
      return sentences.slice(0, keep).join('. ') + '.';
    }

    function expandText(text) {
      // Demo: add descriptive phrases
      const additions = [
        ' The experience was truly unforgettable.',
        ' Every moment felt magical.',
        ' This is what travel dreams are made of.',
        ' I found myself completely immersed in the moment.'
      ];
      const randomAddition = additions[Math.floor(Math.random() * additions.length)];
      return text + (text.endsWith('.') ? '' : '.') + randomAddition;
    }

    function makePersonal(text) {
      // Demo: add personal touch
      const personalPhrases = ['I remember', 'For me,', 'What struck me most was that', 'I loved how'];
      const randomPhrase = personalPhrases[Math.floor(Math.random() * personalPhrases.length)];
      if (!text.toLowerCase().startsWith('i ')) {
        return randomPhrase + ' ' + text.charAt(0).toLowerCase() + text.slice(1);
      }
      return text;
    }

    // Toast
    function showToast(message, type = '') {
      toastMessage.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Instagram Content Import
    function parseInstagramUrls(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      const urlPattern = /instagram\.com\/(p|reel|tv)\/([A-Za-z0-9_-]+)/;
      const validUrls = [];

      lines.forEach(line => {
        const match = line.match(urlPattern);
        if (match) {
          validUrls.push({
            url: line,
            type: match[1], // p, reel, or tv
            shortcode: match[2]
          });
        }
      });

      return validUrls;
    }

    async function importInstagramContent() {
      const textarea = document.getElementById('igUrls');
      const importBtn = document.getElementById('importIgBtn');
      const statusEl = document.getElementById('igImportStatus');
      const urls = parseInstagramUrls(textarea.value);

      if (urls.length === 0) {
        showToast('Please enter valid Instagram URLs');
        return;
      }

      // Disable button and show processing state
      importBtn.disabled = true;
      importBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Importing...
      `;
      statusEl.textContent = `Processing ${urls.length} URL${urls.length > 1 ? 's' : ''}...`;
      statusEl.className = 'ig-import-status processing';

      try {
        // Call the Netlify function to scrape Instagram content
        const response = await fetch('/.netlify/functions/scrape-instagram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            urls: urls.map(u => u.url),
            creator_id: JSON.parse(localStorage.getItem('juno_creator_session') || '{}').id || 'demo'
          })
        });

        const result = await response.json();

        if (result.success) {
          // Add to imported posts
          result.content.forEach(item => {
            importedPosts.push(item);
          });
          renderImportedContent();
          textarea.value = '';
          statusEl.textContent = `${result.content.length} item${result.content.length > 1 ? 's' : ''} imported`;
          statusEl.className = 'ig-import-status success';
          showToast('Content imported successfully!', 'success');
        } else {
          throw new Error(result.error || 'Import failed');
        }
      } catch (error) {
        console.error('Import error:', error);

        // For demo/development: simulate import with pending status
        urls.forEach(urlData => {
          importedPosts.push({
            id: 'temp-' + Date.now() + '-' + urlData.shortcode,
            instagram_url: urlData.url,
            instagram_shortcode: urlData.shortcode,
            content_type: urlData.type === 'reel' ? 'Video' : 'Image',
            thumbnail_url: null, // Will be populated by backend
            status: 'pending',
            caption: ''
          });
        });
        renderImportedContent();
        textarea.value = '';
        statusEl.textContent = `${urls.length} item${urls.length > 1 ? 's' : ''} queued for processing`;
        statusEl.className = 'ig-import-status processing';
        showToast('Content queued - backend processing required', 'success');
      }

      // Reset button
      importBtn.disabled = false;
      importBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Import Content
      `;
    }

    function renderImportedContent() {
      const grid = document.getElementById('igContentGrid');
      const hasPosts = importedPosts.length > 0;
      const hasStories = importedStories.length > 0;

      if (!hasPosts && !hasStories) {
        grid.innerHTML = `
          <div class="ig-content-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <p>Imported posts and stories will appear here</p>
          </div>
        `;
        return;
      }

      let html = '';

      // Stories section (horizontal scroll like Instagram highlights)
      if (hasStories) {
        html += `
          <div class="imported-section">
            <h4 class="imported-section-title">Stories (${importedStories.reduce((sum, g) => sum + g.items.length, 0)} items in ${importedStories.length} highlights)</h4>
            <div class="imported-stories-scroll">
              ${importedStories.map((group, gIndex) => {
                const coverSrc = proxyImageUrl(group.cover_url || group.items[0]?.thumbnail_url || '');
                return `
                <div class="imported-story-group">
                  <div class="story-highlight-circle">
                    <img src="${coverSrc}" alt="${group.title}" onerror="this.style.display='none'">
                  </div>
                  <span class="story-highlight-label">${group.title}</span>
                  <span class="story-highlight-count">${group.items.length}</span>
                  <button type="button" class="remove-btn-small" onclick="removeStoryGroup(${gIndex})" title="Remove"></button>
                </div>
              `;}).join('')}
            </div>
          </div>
        `;
      }

      // Posts section (grid)
      if (hasPosts) {
        html += `
          <div class="imported-section">
            <h4 class="imported-section-title">Posts (${importedPosts.length})</h4>
            <div class="imported-posts-grid">
              ${importedPosts.map((item, index) => {
                const isVideo = item.content_type === 'Video' || item.content_type === 'Sidecar';
                const thumbnailSrc = proxyImageUrl(item.thumbnail_url || item.cloudinary_url || '');
                return `
                  <div class="ig-content-item" data-index="${index}" data-shortcode="${item.instagram_shortcode}">
                    <img src="${thumbnailSrc}" alt="${item.caption || 'Instagram post'}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e5e5e5%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
                    ${isVideo ? `<div class="video-indicator"><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>` : ''}
                    <button type="button" class="remove-btn" onclick="removeImportedPost(${index})" title="Remove">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      grid.innerHTML = html;
      updateImportedContentCount();
    }

    function removeImportedPost(index) {
      importedPosts.splice(index, 1);
      renderImportedContent();
    }

    function removeStoryGroup(index) {
      importedStories.splice(index, 1);
      renderImportedContent();
    }

    // Load existing imported content if editing
    function loadImportedContent(data) {
      if (data) {
        if (data.posts && Array.isArray(data.posts)) {
          importedPosts = data.posts;
        }
        if (data.stories && Array.isArray(data.stories)) {
          importedStories = data.stories;
        }
        renderImportedContent();
      }
    }

    // Get posts for save
    function getPostsForSave() {
      return importedPosts.map(item => ({
        instagram_shortcode: item.instagram_shortcode,
        instagram_url: item.instagram_url,
        content_type: item.content_type,
        cloudinary_url: item.cloudinary_url,
        cloudinary_video_url: item.cloudinary_video_url,
        thumbnail_url: item.thumbnail_url,
        caption: item.caption,
        location: item.location,
        status: item.status
      }));
    }

    // Get stories for save
    function getStoriesForSave() {
      return importedStories.map(group => ({
        id: group.id,
        title: group.title,
        cover_url: group.cover_url,
        items: group.items
      }));
    }

    // ===========================================
    // Instagram Profile Sync Functions (Apify)
    // ===========================================

    // Proxy Instagram images to avoid CORS issues
    function proxyImageUrl(url) {
      if (!url) return '';
      // If already a Cloudinary URL, use it directly
      if (url.includes('cloudinary')) return url;
      // If it's an Instagram CDN URL, proxy it
      if (url.includes('instagram') || url.includes('cdninstagram') || url.includes('fbcdn')) {
        return `/.netlify/functions/image-proxy?url=${encodeURIComponent(url)}`;
      }
      return url;
    }

    // Get creator ID from session
    function getCreatorId() {
      const session = JSON.parse(localStorage.getItem('juno_creator_session') || '{}');
      return session.id || 'demo';
    }

    // Extract username from profile URL
    function extractUsername(url) {
      const match = url.match(/instagram\.com\/([A-Za-z0-9._]+)/);
      if (match) {
        const reserved = ['p', 'reel', 'tv', 'stories', 'explore', 'accounts', 'direct'];
        if (!reserved.includes(match[1].toLowerCase())) {
          return match[1];
        }
      }
      if (/^[A-Za-z0-9._]+$/.test(url)) {
        return url;
      }
      return null;
    }

    // Load saved posts from database (instant, no scraping)
    async function loadSavedPosts() {
      const loadBtn = document.getElementById('loadSavedBtn');
      const statusEl = document.getElementById('syncProfileStatus');
      const postsGrid = document.getElementById('igPostsGrid');

      // Get date filters
      const dateFromInput = document.getElementById('igDateFrom');
      const dateToInput = document.getElementById('igDateTo');
      const dateFrom = dateFromInput.value || null;
      const dateTo = dateToInput.value || null;

      // Show loading state
      loadBtn.disabled = true;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Loading...
      `;
      statusEl.textContent = 'Loading saved posts...';
      statusEl.className = 'ig-import-status processing';

      try {
        const response = await fetch('/.netlify/functions/sync-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'load',
            creator_id: getCreatorId(),
            date_from: dateFrom,
            date_to: dateTo
          })
        });

        const result = await response.json();

        if (result.success) {
          syncedPosts = result.posts || [];
          // Sort by date (newest first)
          syncedPosts.sort((a, b) => {
            const dateA = new Date(a.timestamp || a.taken_at || a.created_at || 0);
            const dateB = new Date(b.timestamp || b.taken_at || b.created_at || 0);
            return dateB - dateA;
          });
          selectedPostIds.clear();
          renderSyncedPosts();
          postsGrid.style.display = 'block';
          statusEl.textContent = `Loaded ${syncedPosts.length} saved posts${dateFrom || dateTo ? ' (filtered by date)' : ''}`;
          statusEl.className = 'ig-import-status success';
        } else {
          throw new Error(result.error || 'Failed to load posts');
        }
      } catch (error) {
        console.error('Load posts error:', error);
        statusEl.textContent = 'Failed to load: ' + error.message;
        statusEl.className = 'ig-import-status error';
      }

      // Reset button
      loadBtn.disabled = false;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Load Saved
      `;
    }

    // Step 1: Sync Instagram Profile Posts (fetch new from Instagram)
    async function syncInstagramProfile() {
      const profileInput = document.getElementById('igProfileUrl');
      const syncBtn = document.getElementById('syncProfileBtn');
      const statusEl = document.getElementById('syncProfileStatus');
      const postsGrid = document.getElementById('igPostsGrid');
      const postsContainer = document.getElementById('igPostsContainer');

      const profileUrl = profileInput.value.trim();
      if (!profileUrl) {
        showToast('Please enter your Instagram profile URL');
        return;
      }

      const username = extractUsername(profileUrl);
      if (!username) {
        showToast('Invalid Instagram profile URL');
        return;
      }

      // Show loading state
      syncBtn.disabled = true;
      syncBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Starting sync...
      `;
      statusEl.textContent = 'Starting Instagram scraper...';
      statusEl.className = 'ig-import-status processing';

      try {
        // Get date filters from inputs (if set)
        const dateFromInput = document.getElementById('igDateFrom');
        const dateToInput = document.getElementById('igDateTo');
        const dateFrom = dateFromInput.value || null;
        const dateTo = dateToInput.value || null;

        // Step 1: Start the sync (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/sync-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profile_url: profileUrl,
            creator_id: getCreatorId(),
            date_from: dateFrom,
            date_to: dateTo
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success) {
          throw new Error(startResult.error || 'Failed to start sync');
        }

        const runId = startResult.run_id;
        statusEl.textContent = `Scraping @${username}... This may take 1-2 minutes.`;
        syncBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Scraping @${username}...
        `;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes max (5 sec intervals)

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
          attempts++;

          const pollResponse = await fetch('/.netlify/functions/sync-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              creator_id: getCreatorId(),
              date_to: dateTo
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            // Success! Show the posts
            syncedPosts = pollResult.posts || [];
            // Sort by date (newest first)
            syncedPosts.sort((a, b) => {
              const dateA = new Date(a.timestamp || a.taken_at || a.created_at || 0);
              const dateB = new Date(b.timestamp || b.taken_at || b.created_at || 0);
              return dateB - dateA;
            });
            selectedPostIds.clear();
            renderSyncedPosts();
            postsGrid.style.display = 'block';
            statusEl.textContent = `Found ${syncedPosts.length} posts from @${username}`;
            statusEl.className = 'ig-import-status success';
            showToast(`Synced ${syncedPosts.length} posts!`, 'success');
            break;
          } else if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Scraping failed');
          } else {
            // Still processing - update status
            statusEl.textContent = `Scraping @${username}... (${attempts * 5}s)`;
          }
        }

        if (attempts >= maxAttempts) {
          throw new Error('Sync timed out after 5 minutes');
        }

      } catch (error) {
        console.error('Profile sync error:', error);
        statusEl.textContent = 'Sync failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to sync profile: ' + error.message);
      }

      // Reset button
      syncBtn.disabled = false;
      syncBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
        </svg>
        Sync Posts
      `;
    }

    // Render synced posts grid
    function renderSyncedPosts() {
      const container = document.getElementById('igPostsContainer');
      const importBtn = document.getElementById('importSelectedBtn');

      if (syncedPosts.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No posts found</p>';
        importBtn.style.display = 'none';
        return;
      }

      container.innerHTML = syncedPosts.map(post => {
        const shortcode = post.shortcode || post.shortCode;
        const isSelected = selectedPostIds.has(shortcode);
        const isVideo = post.post_type === 'Video' || post.video_url;
        const isCarousel = post.post_type === 'Sidecar';

        // thumbnail_url should contain Cloudinary URL (uploaded during sync)
        // Use proxy for Instagram URLs that weren't uploaded to Cloudinary
        const placeholderUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23e5e5e5" width="100" height="100"/%3E%3C/svg%3E';
        const rawUrl = post.thumbnail_url || post.display_url;
        const thumbnailSrc = rawUrl ? proxyImageUrl(rawUrl) : placeholderUrl;

        return `
          <div class="ig-post-item ${isSelected ? 'selected' : ''}"
               data-shortcode="${shortcode}"
               onclick="togglePostSelection('${shortcode}')">
            <img src="${thumbnailSrc}" alt="${post.caption ? post.caption.substring(0, 50) : 'Instagram post'}"
                 onerror="this.src='${placeholderUrl}'">
            ${isVideo ? '<div class="post-type-badge video"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>' : ''}
            ${isCarousel ? '<div class="post-type-badge carousel"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M21 12H9"/></svg></div>' : ''}
            <div class="post-select-indicator ${isSelected ? 'checked' : ''}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
        `;
      }).join('');

      updateSelectedCount();
    }

    // Toggle post selection
    function togglePostSelection(shortcode) {
      if (selectedPostIds.has(shortcode)) {
        selectedPostIds.delete(shortcode);
      } else {
        selectedPostIds.add(shortcode);
      }

      // Update UI
      const item = document.querySelector(`.ig-post-item[data-shortcode="${shortcode}"]`);
      if (item) {
        item.classList.toggle('selected', selectedPostIds.has(shortcode));
        const indicator = item.querySelector('.post-select-indicator');
        if (indicator) {
          indicator.classList.toggle('checked', selectedPostIds.has(shortcode));
        }
      }

      updateSelectedCount();
    }

    // Select all posts
    function selectAllPosts() {
      syncedPosts.forEach(post => {
        const shortcode = post.shortcode || post.shortCode;
        if (shortcode) {
          selectedPostIds.add(shortcode);
        }
      });
      updatePostSelectionUI();
    }

    // Clear all post selections
    function clearAllPosts() {
      selectedPostIds.clear();
      updatePostSelectionUI();
    }

    // Update all post selection UI
    function updatePostSelectionUI() {
      document.querySelectorAll('.ig-post-item').forEach(item => {
        const shortcode = item.dataset.shortcode;
        const isSelected = selectedPostIds.has(shortcode);
        item.classList.toggle('selected', isSelected);
        const indicator = item.querySelector('.post-select-indicator');
        if (indicator) {
          indicator.classList.toggle('checked', isSelected);
        }
      });
      updateSelectedCount();
    }

    // Update selected count
    function updateSelectedCount() {
      const countEl = document.getElementById('selectedCount');
      const importBtn = document.getElementById('importSelectedBtn');
      countEl.textContent = selectedPostIds.size;
      importBtn.style.display = selectedPostIds.size > 0 ? 'inline-flex' : 'none';
    }

    // Import selected posts to itinerary
    async function importSelectedPosts() {
      if (selectedPostIds.size === 0) {
        showToast('Please select posts to import');
        return;
      }

      // Handle both shortcode and shortCode (API returns camelCase, DB returns snake_case)
      const selectedPosts = syncedPosts.filter(p => {
        const code = p.shortcode || p.shortCode;
        return selectedPostIds.has(code);
      });

      // Add to imported posts
      selectedPosts.forEach(post => {
        const shortcode = post.shortcode || post.shortCode;
        // Check if already imported
        const alreadyImported = importedPosts.some(p => p.instagram_shortcode === shortcode);
        if (!alreadyImported) {
          // Use Cloudinary URL if available (thumbnail_url should have it from sync)
          // Cloudinary URLs contain 'cloudinary.com' or 'res.cloudinary'
          const thumbUrl = post.thumbnail_url || '';
          const isCloudinary = thumbUrl.includes('cloudinary');
          const imageUrl = isCloudinary ? thumbUrl : (post.display_url || '');

          importedPosts.push({
            id: post.id,
            instagram_url: `https://instagram.com/p/${shortcode}`,
            instagram_shortcode: shortcode,
            content_type: post.post_type || 'Image',
            thumbnail_url: imageUrl,
            cloudinary_url: isCloudinary ? thumbUrl : null,
            cloudinary_video_url: post.video_url,
            caption: post.caption,
            location: post.location_name,
            status: isCloudinary ? 'ready' : 'pending_upload'
          });
        }
      });

      renderImportedContent();
      selectedPostIds.clear();
      renderSyncedPosts();
      showToast(`${selectedPosts.length} post${selectedPosts.length > 1 ? 's' : ''} imported!`, 'success');
    }

    // Load saved highlights from database (instant)
    async function loadSavedHighlights() {
      const loadBtn = document.getElementById('loadSavedHighlightsBtn');
      const statusEl = document.getElementById('highlightsStatus');
      const highlightsGrid = document.getElementById('igHighlightsGrid');

      // Show loading state
      loadBtn.disabled = true;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Loading...
      `;
      statusEl.textContent = 'Loading saved highlights...';
      statusEl.className = 'ig-import-status processing';

      try {
        const response = await fetch('/.netlify/functions/get-highlights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'load',
            creator_id: getCreatorId()
          })
        });

        const result = await response.json();

        if (result.success) {
          highlights = result.highlights || [];
          renderHighlights();
          highlightsGrid.style.display = 'block';
          statusEl.textContent = `Loaded ${highlights.length} saved highlights`;
          statusEl.className = 'ig-import-status success';
        } else {
          throw new Error(result.error || 'Failed to load highlights');
        }
      } catch (error) {
        console.error('Load highlights error:', error);
        statusEl.textContent = 'Failed to load: ' + error.message;
        statusEl.className = 'ig-import-status error';
      }

      // Reset button
      loadBtn.disabled = false;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Load Saved
      `;
    }

    // Step 2: Get Instagram Highlights (fetch new from Instagram with polling)
    async function getInstagramHighlights() {
      const profileInput = document.getElementById('igProfileUrl');
      const highlightsBtn = document.getElementById('getHighlightsBtn');
      const statusEl = document.getElementById('highlightsStatus');
      const highlightsGrid = document.getElementById('igHighlightsGrid');

      const profileUrl = profileInput.value.trim();
      if (!profileUrl) {
        showToast('Please enter your Instagram profile URL first');
        return;
      }

      const username = extractUsername(profileUrl);
      if (!username) {
        showToast('Invalid Instagram profile URL');
        return;
      }

      // Get date filter value
      const dateFilter = document.getElementById('highlightsDateFilter').value;

      // Show loading state
      highlightsBtn.disabled = true;
      highlightsBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Starting...
      `;
      statusEl.textContent = 'Starting highlights sync...';
      statusEl.className = 'ig-import-status processing';

      try {
        // Step 1: Start the sync (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/get-highlights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profile_url: profileUrl,
            creator_id: getCreatorId(),
            date_filter: dateFilter
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success) {
          throw new Error(startResult.error || 'Failed to start sync');
        }

        const runId = startResult.run_id;
        statusEl.textContent = `Syncing highlights for @${username}...`;
        highlightsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Syncing...
        `;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes max

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
          attempts++;

          const pollResponse = await fetch('/.netlify/functions/get-highlights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              creator_id: getCreatorId(),
              date_filter: dateFilter
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            highlights = pollResult.highlights || [];
            renderHighlights();
            highlightsGrid.style.display = 'block';
            statusEl.textContent = `Found ${highlights.length} highlight${highlights.length !== 1 ? 's' : ''}`;
            statusEl.className = 'ig-import-status success';
            showToast(`Found ${highlights.length} highlights!`, 'success');
            break;
          } else if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Sync failed');
          } else {
            statusEl.textContent = `Syncing highlights... (${attempts * 5}s)`;
          }
        }

        if (attempts >= maxAttempts) {
          throw new Error('Sync timed out after 5 minutes');
        }

      } catch (error) {
        console.error('Highlights error:', error);
        statusEl.textContent = 'Failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to load highlights: ' + error.message);
      }

      // Reset button
      highlightsBtn.disabled = false;
      highlightsBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        Sync New
      `;
    }

    // Render highlights grid
    function renderHighlights() {
      const container = document.getElementById('igHighlightsContainer');

      // Filter out highlights without valid IDs (need 10+ chars minimum)
      const validHighlights = highlights.filter(h => h.id && h.id.length >= 10);

      if (validHighlights.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No highlights found</p>';
        return;
      }

      // Gradient fallbacks for when images fail to load
      const gradients = [
        'linear-gradient(135deg, #833AB4, #FD1D1D, #F77737)',
        'linear-gradient(135deg, #405DE6, #5851DB, #833AB4)',
        'linear-gradient(135deg, #F77737, #FCAF45, #FFDC80)',
        'linear-gradient(135deg, #C13584, #E1306C, #FD1D1D)',
        'linear-gradient(135deg, #5851DB, #833AB4, #C13584)'
      ];

      container.innerHTML = validHighlights.map((highlight, index) => {
        const gradient = gradients[index % gradients.length];
        const initial = (highlight.title || 'H')[0].toUpperCase();

        // Get image URL - use Cloudinary if available, otherwise proxy Instagram URL
        let imageUrl = highlight.coverUrl ? proxyImageUrl(highlight.coverUrl) : null;

        return `
          <div class="ig-highlight-item" onclick="downloadHighlightStories('${highlight.id}', '${(highlight.title || '').replace(/'/g, "\\'")}')">
            <div class="highlight-cover" style="background: ${gradient};">
              ${imageUrl ? `
                <img src="${imageUrl}" alt="${highlight.title || ''}"
                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <span style="display: none; color: white; font-size: 1.5rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3); width: 100%; height: 100%; align-items: center; justify-content: center;">${initial}</span>
              ` : `
                <span style="color: white; font-size: 1.5rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">${initial}</span>
              `}
            </div>
            <span class="highlight-title">${highlight.title || 'Untitled'}</span>
            ${highlight.storiesCount ? `<span class="highlight-count">${highlight.storiesCount} stories</span>` : ''}
          </div>
        `;
      }).join('');
    }

    // Step 3: Download stories from a highlight (async with polling)
    async function downloadHighlightStories(highlightId, highlightTitle) {
      const statusEl = document.getElementById('highlightsStatus');
      const storiesGrid = document.getElementById('igStoriesGrid');
      const storiesContainer = document.getElementById('igStoriesContainer');

      // Validate highlight ID before making request
      if (!highlightId || highlightId.length < 10) {
        statusEl.textContent = 'Invalid highlight ID. Please re-sync your highlights.';
        statusEl.className = 'ig-import-status error';
        return;
      }

      // Show loading state
      statusEl.textContent = `Downloading stories from "${highlightTitle || highlightId}"...`;
      statusEl.className = 'ig-import-status processing';

      try {
        // Step 1: Start the download (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/download-stories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            highlight_id: highlightId,
            highlight_title: highlightTitle,
            creator_id: getCreatorId()
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success && startResult.status !== 'processing') {
          throw new Error(startResult.error || 'Failed to start stories download');
        }

        const runId = startResult.run_id;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 30; // 30 * 2 seconds = 60 seconds max
        const pollInterval = 2000;

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, pollInterval));
          attempts++;

          statusEl.textContent = `Downloading stories from "${highlightTitle}"... (${attempts * 2}s)`;

          const pollResponse = await fetch('/.netlify/functions/download-stories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              highlight_title: highlightTitle,
              creator_id: getCreatorId()
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            downloadedStories = pollResult.stories || [];
            renderDownloadedStories(highlightTitle);
            storiesGrid.style.display = 'block';
            statusEl.textContent = `Downloaded ${downloadedStories.length} stories from "${highlightTitle}"`;
            statusEl.className = 'ig-import-status success';
            showToast(`Downloaded ${downloadedStories.length} stories!`, 'success');
            return;
          }

          if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Stories download failed');
          }

          // Still processing, continue polling
        }

        throw new Error('Download timed out. Please try again.');
      } catch (error) {
        console.error('Download stories error:', error);
        statusEl.textContent = 'Failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to download stories: ' + error.message);
      }
    }

    // Render downloaded stories with selection
    function renderDownloadedStories(highlightTitle) {
      const container = document.getElementById('igStoriesContainer');
      selectedStoryIndices.clear();

      if (downloadedStories.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No stories found in this highlight</p>';
        return;
      }

      container.innerHTML = `
        <div class="stories-import-header">
          <span>${downloadedStories.length} stories from "${highlightTitle || 'Highlight'}"</span>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllStories()">Select All</button>
            <button type="button" class="btn btn-primary btn-sm" id="importSelectedStoriesBtn" onclick="importSelectedStories('${(highlightTitle || '').replace(/'/g, "\\'")}')">
              Import Selected (<span id="selectedStoryCount">0</span>)
            </button>
          </div>
        </div>
        <div class="stories-grid">
          ${downloadedStories.map((story, index) => {
            const isVideo = story.type === 'video';
            // Use cloudinary_url or thumbnail_url from backend, proxy if needed
            const rawUrl = story.cloudinary_url || story.thumbnail_url || story.thumbnailUrl || story.mediaUrl;
            const placeholderSrc = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23e5e5e5" width="100" height="100"/%3E%3C/svg%3E';
            const thumbnailSrc = rawUrl ? proxyImageUrl(rawUrl) : placeholderSrc;

            return `
              <div class="ig-story-item" data-index="${index}" onclick="toggleStorySelection(${index})">
                <img src="${thumbnailSrc}" alt="Story ${index + 1}"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e5e5e5%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
                ${isVideo ? '<div class="story-type-badge"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>' : ''}
                <div class="post-select-indicator">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Toggle story selection
    function toggleStorySelection(index) {
      if (selectedStoryIndices.has(index)) {
        selectedStoryIndices.delete(index);
      } else {
        selectedStoryIndices.add(index);
      }
      updateStorySelectionUI();
    }

    // Select all stories
    function selectAllStories() {
      if (selectedStoryIndices.size === downloadedStories.length) {
        selectedStoryIndices.clear();
      } else {
        downloadedStories.forEach((_, index) => selectedStoryIndices.add(index));
      }
      updateStorySelectionUI();
    }

    // Update story selection UI
    function updateStorySelectionUI() {
      document.querySelectorAll('.ig-story-item').forEach((el, index) => {
        if (selectedStoryIndices.has(index)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      const countEl = document.getElementById('selectedStoryCount');
      if (countEl) countEl.textContent = selectedStoryIndices.size;
    }

    // Import selected stories
    function importSelectedStories(highlightTitle) {
      if (selectedStoryIndices.size === 0) {
        showToast('Please select stories to import');
        return;
      }

      const selectedStoriesData = downloadedStories.filter((_, index) => selectedStoryIndices.has(index));

      // Check if this highlight already exists
      let storyGroup = importedStories.find(g => g.title === highlightTitle);
      if (!storyGroup) {
        storyGroup = {
          id: `highlight-${Date.now()}`,
          title: highlightTitle || 'Stories',
          cover_url: selectedStoriesData[0]?.cloudinary_url || selectedStoriesData[0]?.thumbnail_url || '',
          items: []
        };
        importedStories.push(storyGroup);
      }

      selectedStoriesData.forEach((story, index) => {
        storyGroup.items.push({
          id: story.id || `story-${Date.now()}-${index}`,
          type: story.type === 'video' ? 'video' : 'image',
          url: story.cloudinary_url || story.mediaUrl,
          thumbnail_url: story.cloudinary_url || story.thumbnail_url || story.thumbnailUrl || story.mediaUrl
        });
      });

      renderImportedContent();
      selectedStoryIndices.clear();
      updateStorySelectionUI();
      showToast(`${selectedStoriesData.length} stories imported to "${highlightTitle}"!`, 'success');
      updateImportedContentCount();
    }

    // Update imported content count display
    function updateImportedContentCount() {
      const countEl = document.getElementById('importedContentCount');
      const totalStoryItems = importedStories.reduce((sum, g) => sum + g.items.length, 0);
      const total = importedPosts.length + totalStoryItems;
      if (countEl) countEl.textContent = `${importedPosts.length} posts, ${totalStoryItems} stories`;
    }

    // Generate itinerary with AI
    async function generateItineraryWithAI() {
      const numDays = parseInt(document.getElementById('numDays').value) || 4;
      const tripContext = document.getElementById('tripContext').value.trim();
      const generateBtn = document.getElementById('generateItineraryBtn');
      const statusEl = document.getElementById('generateStatus');

      const totalContent = importedPosts.length + importedStories.reduce((sum, g) => sum + g.items.length, 0);
      if (totalContent === 0) {
        showToast('Please import some content first (posts or stories)');
        return;
      }

      // Show loading state
      generateBtn.disabled = true;
      generateBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;" width="20" height="20">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Generating...
      `;
      statusEl.textContent = 'AI is creating your itinerary...';
      statusEl.className = 'ig-import-status processing';

      // Gather stays data
      const staysData = [];
      document.querySelectorAll('#staysList .stay-item').forEach(stayItem => {
        const name = stayItem.querySelector('.stay-name')?.value?.trim();
        const location = stayItem.querySelector('.stay-location')?.value?.trim();
        const description = stayItem.querySelector('.stay-description')?.value?.trim();
        const pricePerNight = parseFloat(stayItem.querySelector('.stay-price')?.value) || null;
        const images = Array.from(stayItem.querySelectorAll('.stay-gallery-item')).map(img => img.dataset.url);
        if (name) {
          staysData.push({ name, location, description, price_per_night: pricePerNight, images });
        }
      });

      try {
        const response = await fetch('/.netlify/functions/generate-itinerary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            posts: importedPosts,
            stories: importedStories,
            num_days: numDays,
            context: tripContext,
            creator_id: getCreatorId(),
            stays: staysData
          })
        });

        const result = await response.json();

        if (result.success) {
          // Populate the form with generated content
          if (result.title) {
            document.getElementById('title').value = result.title;
          }
          if (result.destination) {
            document.getElementById('destination').value = result.destination;
          }
          if (result.location) {
            document.getElementById('location').value = result.location;
          }
          if (result.duration) {
            document.getElementById('duration').value = result.duration;
          }
          if (result.intro) {
            document.getElementById('intro').value = result.intro;
          }

          // Best For tags
          if (result.best_for && result.best_for.length > 0) {
            // Clear existing tags
            document.querySelectorAll('#bestForTags .tag').forEach(t => t.remove());
            // Add new tags
            result.best_for.forEach(tag => addTag('bestForTags', tag));
          }

          // Generate days
          console.log('Generation result:', result);
          console.log('Days from result:', result.days);

          if (result.days && result.days.length > 0) {
            // Clear existing days
            const daysListEl = document.getElementById('daysList');
            daysListEl.innerHTML = '';

            // Add generated days using addDay function
            result.days.forEach((dayData, index) => {
              console.log('Adding day:', dayData);
              addDay({
                title: dayData.title || `Day ${index + 1}`,
                description: dayData.description || '',
                activities: dayData.activities || []
              });
            });
          } else {
            console.warn('No days in result or days array is empty');
          }

          // Populate gallery from imported content
          if (result.gallery && result.gallery.length > 0) {
            populateGallery(result.gallery);
          }

          // Populate stays with AI-generated descriptions, prices, and images
          if (result.stays && result.stays.length > 0) {
            const staysListEl = document.getElementById('staysList');
            staysListEl.innerHTML = '';
            result.stays.forEach(stayData => {
              addStay({
                name: stayData.name || '',
                location: stayData.location || '',
                description: stayData.description || '',
                price_per_night: stayData.price_per_night || null,
                image_url: stayData.image_url || ''
              });
            });
            // Update calculated price after adding stays with AI-estimated prices
            updateCalculatedPrice();
          }

          statusEl.textContent = 'Itinerary generated successfully!';
          statusEl.className = 'ig-import-status success';
          showToast('Itinerary generated! Review and edit as needed.', 'success');

          // Scroll to top of form to show generated content
          document.getElementById('title').scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Update preview
          updatePreview();
        } else {
          throw new Error(result.error || 'Failed to generate itinerary');
        }
      } catch (error) {
        console.error('Generate error:', error);
        statusEl.textContent = 'Generation failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to generate itinerary: ' + error.message);
      }

      // Reset button
      generateBtn.disabled = false;
      generateBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
          <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
          <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
        </svg>
        Generate Itinerary
      `;
    }

    // Preview gallery functions
    let previewGalleryImages = [];

    function openPreviewGallery() {
      const galleryHtml = `
        <div class="pv-gallery-modal" id="pvGalleryModal" onclick="if(event.target === this) closePvGallery()">
          <button class="pv-gallery-close" onclick="closePvGallery()"></button>
          <div class="pv-gallery-content">
            <div class="pv-gallery-grid">
              ${previewGalleryImages.map((img, i) => `
                <div class="pv-gallery-item" onclick="showPvImage(${i})">
                  <img src="${img.url}" alt="">
                  ${img.type === 'video' ? '<span class="pv-gallery-video-icon"></span>' : ''}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', galleryHtml);
    }

    function closePvGallery() {
      document.getElementById('pvGalleryModal')?.remove();
    }

    function openStayGallery(images, name) {
      const galleryHtml = `
        <div class="pv-gallery-modal" id="pvGalleryModal" onclick="if(event.target === this) closePvGallery()">
          <button class="pv-gallery-close" onclick="closePvGallery()"></button>
          <div class="pv-gallery-content">
            <h3 style="color: #fff; margin-bottom: 16px; text-align: center;">${name}</h3>
            <div class="pv-gallery-grid">
              ${images.map((img, i) => `
                <div class="pv-gallery-item">
                  <img src="${img}" alt="${name}">
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', galleryHtml);
    }

    // Preview modal - Full front-end style preview
    function showPreviewModal() {
      const title = document.getElementById('title').value || 'Untitled Itinerary';
      const destination = document.getElementById('destination').value || '';
      const location = document.getElementById('location').value || '';
      const duration = document.getElementById('duration').value || '';
      const intro = document.getElementById('intro').value || '';
      const whyCurated = document.getElementById('whyCurated')?.value || '';
      const priceFrom = document.getElementById('priceFrom')?.value || '';
      const heroImage = itineraryData.heroImage || '';
      const bestFor = Array.from(document.querySelectorAll('#bestForTags .tag'))
        .map(t => t.textContent.trim().replace('', '').trim());

      // Get creator info from session
      const session = JSON.parse(localStorage.getItem('juno_creator_session') || '{}');
      const creatorName = session.display_name || session.instagram || 'Creator';
      const creatorInstagram = session.instagram || creatorName.toLowerCase().replace(/\s+/g, '');
      const creatorAvatar = session.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(creatorName)}&background=c2703e&color=fff&size=100`;

      // Get days with media
      const days = Array.from(document.getElementById('daysList').children).map((card, i) => {
        const mediaItems = Array.from(card.querySelectorAll('.day-media-grid img, .day-media-grid video')).map(el => ({
          type: el.tagName.toLowerCase() === 'video' ? 'video' : 'image',
          src: el.src || el.querySelector('source')?.src
        }));
        return {
          dayNumber: i + 1,
          title: card.querySelector('.day-card-header input').value || `Day ${i + 1}`,
          description: card.querySelector('.day-description').value || '',
          activities: (card.querySelector('.day-activities').value || '').split(',').map(a => a.trim()).filter(Boolean),
          media: mediaItems
        };
      });

      // Get stays
      const stays = Array.from(document.getElementById('staysList').children).map(item => {
        const images = Array.from(item.querySelectorAll('.stay-gallery-item')).map(img => img.dataset.url);
        return {
          name: item.querySelector('.stay-name')?.value || '',
          location: item.querySelector('.stay-location')?.value || '',
          description: item.querySelector('.stay-description')?.value || '',
          price_per_night: parseFloat(item.querySelector('.stay-price')?.value) || 0,
          images: images
        };
      }).filter(s => s.name);

      // Calculate estimated price from stays
      // Extract number of nights from duration (e.g., "5 days / 4 nights" -> 4)
      const nightsMatch = duration.match(/(\d+)\s*nights?/i) || duration.match(/(\d+)\s*days?/i);
      const numNights = nightsMatch ? parseInt(nightsMatch[1]) - (duration.includes('days') && !duration.includes('nights') ? 1 : 0) : 0;

      // Calculate total from stays with prices
      const staysWithPrices = stays.filter(s => s.price_per_night > 0);
      let calculatedPrice = 0;
      if (staysWithPrices.length > 0 && numNights > 0) {
        // Average nightly rate across all stays
        const avgNightlyRate = staysWithPrices.reduce((sum, s) => sum + s.price_per_night, 0) / staysWithPrices.length;
        calculatedPrice = Math.round(avgNightlyRate * numNights);
      }

      // Use calculated price if no manual price entered
      const displayPrice = priceFrom || (calculatedPrice > 0 ? calculatedPrice.toString() : '');

      // Get imported posts for gallery (proxy the URLs)
      const galleryPosts = importedPosts.map(post => ({
        url: proxyImageUrl(post.thumbnail_url || post.cloudinary_url || ''),
        type: post.content_type === 'Video' ? 'video' : 'image',
        caption: post.caption || '',
        location: post.location || ''
      }));

      // Store for gallery modal
      previewGalleryImages = galleryPosts;

      // Get imported stories for carousel
      const storyGroups = importedStories.map(group => ({
        title: group.title,
        coverUrl: proxyImageUrl(group.cover_url || group.items[0]?.thumbnail_url || ''),
        count: group.items.length
      }));

      // Create full-page preview matching senegal-soul.html template
      const modal = document.createElement('div');
      modal.className = 'preview-modal-fullpage';
      modal.innerHTML = `
        <div class="preview-toolbar">
          <div class="preview-toolbar-left">
            <span class="preview-badge">Preview Mode</span>
            <span class="preview-device-info">Desktop View</span>
          </div>
          <div class="preview-toolbar-right">
            <button class="preview-close-btn" onclick="this.closest('.preview-modal-fullpage').remove()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              Close Preview
            </button>
          </div>
        </div>
        <div class="preview-frame">
          <!-- Hero Section -->
          <section class="pv-hero" style="background-image: url('${heroImage || 'https://images.unsplash.com/photo-1516026672322-bc52d61a55d5?w=1600'}');">
            <div class="pv-hero-overlay"></div>
            ${galleryPosts.length > 0 ? `
              <button class="pv-hero-gallery-btn" onclick="openPreviewGallery()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                View Gallery (${galleryPosts.length})
              </button>
            ` : ''}
            <div class="pv-hero-content">
              <div class="pv-container">
                <div class="pv-hero-inner">
                  <h1>${title}</h1>
                  <p class="pv-hero-location">${[destination, location].filter(Boolean).join(', ')}</p>
                  ${intro ? `<p class="pv-hero-subtitle">${intro}</p>` : ''}
                  <div class="pv-hero-actions">
                    <button class="pv-btn pv-btn-primary">Book or customise</button>
                    <button class="pv-btn pv-btn-secondary">Ask a question</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Instagram Profile Section -->
          <section class="pv-profile-section">
            <div class="pv-profile-header">
              <img class="pv-profile-avatar" src="${creatorAvatar}" alt="${creatorName}">
              <div class="pv-profile-info">
                <span class="pv-profile-label">Curated by</span>
                <h3 class="pv-profile-username">
                  ${creatorInstagram}
                  <svg class="pv-verified" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                </h3>
                <p class="pv-profile-bio">${destination || 'Travel'}, ${new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</p>
              </div>
            </div>
          </section>

          <!-- Stories Carousel -->
          ${storyGroups.length > 0 ? `
          <section class="pv-stories-section">
            <div class="pv-stories-scroll">
              ${storyGroups.map(story => `
                <div class="pv-story-item">
                  <div class="pv-story-ring">
                    <div class="pv-story-ring-inner">
                      <img src="${story.coverUrl}" alt="${story.title}" onerror="this.style.background='linear-gradient(135deg, #833AB4, #FD1D1D, #F77737)'; this.style.display='none';">
                    </div>
                  </div>
                  <span class="pv-story-label">${story.title}</span>
                </div>
              `).join('')}
            </div>
          </section>
          ` : ''}

          <!-- Content Gallery -->
          ${galleryPosts.length > 0 ? `
          <section class="pv-gallery-section">
            <div class="pv-ig-tabs">
              <div class="pv-ig-tab active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                Posts
              </div>
              <div class="pv-ig-tab">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                Reels
              </div>
            </div>
            <div class="pv-gallery-grid">
              ${galleryPosts.map(post => `
                <div class="pv-gallery-item">
                  <img src="${post.url}" alt="">
                  ${post.type === 'video' ? `
                    <div class="pv-gallery-overlay">
                      <svg class="pv-play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z"/></svg>
                    </div>
                  ` : ''}
                  <div class="pv-gallery-caption">
                    ${post.location ? `<div class="pv-gallery-location">${post.location}</div>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </section>
          ` : ''}

          <!-- Snapshot Bar -->
          <section class="pv-snapshot-bar">
            <div class="pv-container">
              <div class="pv-snapshot-grid">
                <div class="pv-snapshot-item">
                  <div class="pv-snapshot-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>
                  </div>
                  <div>
                    <span class="pv-snapshot-label">Duration</span>
                    <span class="pv-snapshot-value">${duration || '-- nights'}</span>
                  </div>
                </div>
                <div class="pv-snapshot-item">
                  <div class="pv-snapshot-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                  </div>
                  <div>
                    <span class="pv-snapshot-label">Style</span>
                    <span class="pv-snapshot-value">${bestFor[0] || 'Adventure'}</span>
                  </div>
                </div>
                <div class="pv-snapshot-item">
                  <div class="pv-snapshot-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg>
                  </div>
                  <div>
                    <span class="pv-snapshot-label">Best for</span>
                    <span class="pv-snapshot-value">${bestFor.slice(0, 3).join(', ') || 'Everyone'}</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Main Content Grid -->
          <section class="pv-content">
            <div class="pv-container">
              <div class="pv-grid">
                <div class="pv-main">
                  <!-- Creator Voice -->
                  ${whyCurated ? `
                  <div class="pv-creator-voice">
                    <div class="pv-creator-voice-header">
                      <img src="${creatorAvatar}" alt="${creatorName}">
                      <div>
                        <span class="pv-label">Why I curated this</span>
                        <p class="pv-name">${creatorName}</p>
                      </div>
                    </div>
                    <blockquote>"${whyCurated}"</blockquote>
                  </div>
                  ` : ''}

                  <!-- Itinerary Accordion -->
                  <div class="pv-itinerary-accordion">
                    <h2 class="pv-section-title">The Itinerary</h2>
                    ${days.map((day, i) => `
                      <div class="pv-accordion-item ${i === 0 ? 'active' : ''}">
                        <button class="pv-accordion-header">
                          <div class="pv-accordion-header-content">
                            <span class="pv-accordion-days">Day ${day.dayNumber}</span>
                            <div>
                              <h3 class="pv-accordion-title">${day.title}</h3>
                            </div>
                          </div>
                          <svg class="pv-accordion-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.5 8.25l-7.5 7.5-7.5-7.5"/></svg>
                        </button>
                        <div class="pv-accordion-panel">
                          ${day.description ? `<p>${day.description}</p>` : ''}
                          ${day.activities.length > 0 ? `
                            <div class="pv-accordion-highlights">
                              ${day.activities.map(a => `<span class="pv-highlight-tag">${a}</span>`).join('')}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>

                  <!-- Stays Section -->
                  ${stays.length > 0 ? `
                  <div class="pv-stays-section">
                    <h2 class="pv-section-title">Where You Stay</h2>
                    <div class="pv-stays-scroll">
                      ${stays.map(stay => `
                        <div class="pv-stay-card">
                          ${stay.images && stay.images.length > 0 ? `
                            <div class="pv-stay-card-gallery">
                              <img src="${stay.images[0]}" alt="${stay.name}" class="pv-stay-card-main-img">
                              ${stay.images.length > 1 ? `
                                <button class="pv-stay-gallery-btn" onclick="openStayGallery(${JSON.stringify(stay.images).replace(/"/g, '&quot;')}, '${stay.name}')">
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                  </svg>
                                  +${stay.images.length - 1}
                                </button>
                              ` : ''}
                            </div>
                          ` : ''}
                          <div class="pv-stay-card-content">
                            <h3 class="pv-stay-card-name">${stay.name}</h3>
                            <p class="pv-stay-card-location">${stay.location}</p>
                            ${stay.description ? `<p class="pv-stay-card-desc">${stay.description}</p>` : ''}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  ` : ''}
                </div>

                <!-- Sidebar -->
                <aside class="pv-sidebar">
                  <div class="pv-sidebar-cta">
                    <h3>Book this trip</h3>
                    <p>Let us handle the details. We'll customise this itinerary to your dates and preferences.</p>
                    <button class="pv-btn pv-btn-dark">Book or customise</button>
                    <button class="pv-btn pv-btn-outline">Ask a question</button>
                    ${displayPrice ? `
                    <div class="pv-sidebar-cta-meta">
                      <p><strong>From $${parseInt(displayPrice).toLocaleString()}</strong> per person per night</p>
                      <p>${duration}${staysWithPrices.length > 0 ? ', all accommodation' : ''}</p>
                      ${calculatedPrice > 0 && !priceFrom ? '<p style="font-size: 0.75rem; opacity: 0.7;">(Calculated from stay prices)</p>' : ''}
                    </div>
                    ` : ''}
                  </div>
                  <div class="pv-sidebar-info">
                    <div class="pv-sidebar-info-item">
                      <div class="pv-sidebar-info-label">Best time to visit</div>
                      <div class="pv-sidebar-info-value">Year-round</div>
                    </div>
                    <div class="pv-sidebar-info-item">
                      <div class="pv-sidebar-info-label">Getting there</div>
                      <div class="pv-sidebar-info-value">Fly into ${destination}</div>
                    </div>
                  </div>
                </aside>
              </div>
            </div>
          </section>

          <!-- Final CTA -->
          <section class="pv-final-cta">
            <div class="pv-container">
              <h2>Ready to experience ${destination || 'this adventure'}?</h2>
              <p>This itinerary can be customised to your dates, extended, or combined with other destinations.</p>
              <button class="pv-btn pv-btn-primary">Start planning</button>
            </div>
          </section>
        </div>
      `;
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';

      // Handle accordion clicks
      modal.querySelectorAll('.pv-accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const item = header.parentElement;
          const isActive = item.classList.contains('active');
          modal.querySelectorAll('.pv-accordion-item').forEach(i => i.classList.remove('active'));
          if (!isActive) item.classList.add('active');
        });
      });

      // Handle close
      modal.querySelector('.preview-close-btn').addEventListener('click', () => {
        document.body.style.overflow = '';
      });
    }
  </script>

  <!-- Full Page Preview Styles (matches senegal-soul.html template) -->
  <style>
    .preview-modal-fullpage {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #fff;
      overflow-y: auto;
    }
    .preview-toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
      background: #1a1a1a;
      color: #fff;
    }
    .preview-toolbar-left { display: flex; align-items: center; gap: 16px; }
    .preview-badge {
      background: #c2703e;
      color: #fff;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .preview-device-info { color: rgba(255,255,255,0.6); font-size: 0.8125rem; }
    .preview-close-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: #fff;
      font-size: 0.875rem;
      cursor: pointer;
    }
    .preview-close-btn:hover { background: rgba(255,255,255,0.2); }
    .preview-close-btn svg { width: 16px; height: 16px; }
    .preview-frame { font-family: 'Inter', -apple-system, sans-serif; }
    .pv-container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

    /* Hero */
    .pv-hero {
      position: relative;
      min-height: 85vh;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: flex-end;
    }
    .pv-hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.3) 40%, rgba(0,0,0,0.2) 100%);
    }
    .pv-hero-content {
      position: relative;
      z-index: 2;
      width: 100%;
      padding: 60px 0;
      color: #fff;
    }
    .pv-hero-inner { max-width: 700px; }
    .pv-hero h1 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: clamp(2.5rem, 6vw, 4rem);
      font-weight: 400;
      margin-bottom: 12px;
      line-height: 1.1;
    }
    .pv-hero-location { font-size: 1.125rem; margin-bottom: 16px; }
    .pv-hero-subtitle { font-size: 1rem; line-height: 1.6; max-width: 500px; margin-bottom: 24px; }
    .pv-hero-actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .pv-hero-gallery-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.95);
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .pv-hero-gallery-btn:hover {
      background: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    /* Buttons */
    .pv-btn {
      padding: 14px 28px;
      border-radius: 0;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .pv-btn-primary { background: #fff; color: #1a1a1a; }
    .pv-btn-primary:hover { background: #f5f5f5; }
    .pv-btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.6); color: #fff; }
    .pv-btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .pv-btn-dark { background: #1a1a1a; color: #fff; width: 100%; margin-bottom: 8px; }
    .pv-btn-outline { background: transparent; border: 1px solid #1a1a1a; color: #1a1a1a; width: 100%; }

    /* Instagram Profile Section */
    .pv-profile-section { background: #fff; padding: 24px 0 16px; }
    .pv-profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }
    .pv-profile-avatar {
      width: 77px;
      height: 77px;
      border-radius: 50%;
      border: 1px solid #e5e5e5;
      object-fit: cover;
    }
    .pv-profile-info { flex: 1; }
    .pv-profile-label {
      font-size: 0.75rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: block;
      margin-bottom: 2px;
    }
    .pv-profile-username {
      color: #1a1a1a;
      font-size: 1.125rem;
      font-weight: 500;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pv-verified { width: 16px; height: 16px; color: #3897f0; }
    .pv-profile-bio { color: #888; font-size: 0.8125rem; }

    /* Stories Carousel */
    .pv-stories-section {
      background: #fff;
      padding: 0 24px 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .pv-stories-scroll {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 8px;
      scrollbar-width: none;
    }
    .pv-stories-scroll::-webkit-scrollbar { display: none; }
    .pv-story-item {
      flex: 0 0 auto;
      text-align: center;
      width: 100px;
    }
    .pv-story-ring {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      margin: 0 auto 8px;
    }
    .pv-story-ring-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid #fff;
      overflow: hidden;
      background: linear-gradient(135deg, #833AB4, #FD1D1D, #F77737);
    }
    .pv-story-ring-inner img { width: 100%; height: 100%; object-fit: cover; }
    .pv-story-label {
      font-size: 0.75rem;
      color: #1a1a1a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Content Gallery */
    .pv-gallery-section { background: #1a1a1a; padding: 8px 0 24px; }
    .pv-ig-tabs {
      display: flex;
      justify-content: center;
      border-top: 1px solid #e5e5e5;
      background: #fff;
      max-width: 1200px;
      margin: 0 auto;
    }
    .pv-ig-tab {
      padding: 12px 24px;
      color: #888;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-top: 1px solid transparent;
      margin-top: -1px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .pv-ig-tab.active { color: #1a1a1a; border-top-color: #1a1a1a; }
    .pv-ig-tab svg { width: 12px; height: 12px; }
    .pv-gallery-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .pv-gallery-item {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      background: #000;
    }
    .pv-gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    .pv-gallery-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .pv-gallery-item:hover .pv-gallery-overlay { opacity: 1; }
    .pv-play-icon { width: 48px; height: 48px; color: #fff; }
    .pv-gallery-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      color: #fff;
      font-size: 0.75rem;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .pv-gallery-item:hover .pv-gallery-caption { opacity: 1; }
    .pv-gallery-location { text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.6875rem; }

    /* Snapshot Bar */
    .pv-snapshot-bar { background: #f9f7f4; padding: 16px 0; border-bottom: 1px solid #e5e5e5; }
    .pv-snapshot-grid { display: flex; justify-content: center; gap: 48px; flex-wrap: wrap; }
    .pv-snapshot-item { display: flex; align-items: center; gap: 12px; }
    .pv-snapshot-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      border-radius: 50%;
    }
    .pv-snapshot-icon svg { width: 20px; height: 20px; color: #c2703e; }
    .pv-snapshot-label {
      font-size: 0.6875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #888;
      display: block;
    }
    .pv-snapshot-value { font-size: 0.9375rem; color: #1a1a1a; font-weight: 500; }

    /* Main Content */
    .pv-content { padding: 48px 0; }
    .pv-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 48px;
      align-items: start;
    }
    .pv-main { min-width: 0; }
    .pv-section-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: 24px;
    }

    /* Creator Voice */
    .pv-creator-voice {
      background: #faf8f5;
      padding: 24px;
      margin-bottom: 48px;
    }
    .pv-creator-voice-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    .pv-creator-voice-header img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
    }
    .pv-creator-voice-header .pv-label {
      font-size: 0.6875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #888;
    }
    .pv-creator-voice-header .pv-name {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.125rem;
      margin: 0;
    }
    .pv-creator-voice blockquote {
      font-size: 1rem;
      line-height: 1.7;
      color: #555;
      margin: 0;
      font-style: italic;
    }

    /* Accordion */
    .pv-itinerary-accordion { margin-bottom: 48px; }
    .pv-accordion-item { border-bottom: 1px solid #e5e5e5; }
    .pv-accordion-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      background: none;
      border: none;
      cursor: pointer;
      text-align: left;
    }
    .pv-accordion-header-content { display: flex; align-items: center; gap: 16px; }
    .pv-accordion-days {
      font-size: 0.6875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #c2703e;
      min-width: 50px;
    }
    .pv-accordion-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.25rem;
      margin: 0;
    }
    .pv-accordion-icon {
      width: 24px;
      height: 24px;
      color: #888;
      transition: transform 0.3s;
    }
    .pv-accordion-item.active .pv-accordion-icon { transform: rotate(180deg); }
    .pv-accordion-panel {
      display: none;
      padding: 0 0 24px 66px;
    }
    .pv-accordion-item.active .pv-accordion-panel { display: block; }
    .pv-accordion-panel p {
      font-size: 0.9375rem;
      line-height: 1.7;
      color: #555;
      margin-bottom: 16px;
    }
    .pv-accordion-highlights { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; }
    .pv-highlight-tag {
      font-size: 0.6875rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 4px 10px;
      background: #f9f7f4;
      color: #1a1a1a;
    }

    /* Stays Section */
    .pv-stays-section { margin-bottom: 48px; }
    .pv-stays-scroll { display: flex; gap: 24px; overflow-x: auto; padding-bottom: 16px; }
    .pv-stay-card {
      flex: 0 0 320px;
      background: #f9f7f4;
      border-radius: 8px;
      overflow: hidden;
    }
    .pv-stay-card-image {
      width: 100%;
      height: 180px;
      overflow: hidden;
    }
    .pv-stay-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .pv-stay-card-content {
      padding: 20px;
    }
    .pv-stay-card-name {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: 1.125rem;
      margin-bottom: 4px;
    }
    .pv-stay-card-location { font-size: 0.75rem; color: #888; margin-bottom: 8px; }
    .pv-stay-card-desc {
      font-size: 0.875rem;
      color: #555;
      line-height: 1.5;
      margin-top: 8px;
    }
    .pv-stay-card-nights {
      display: inline-block;
      margin-top: 12px;
      font-size: 0.6875rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: #fff;
      padding: 4px 10px;
    }
    .pv-stay-card-gallery {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
    }
    .pv-stay-card-main-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .pv-stay-gallery-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.95);
      color: #1a1a1a;
      border: none;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
    }
    .pv-stay-gallery-btn:hover {
      background: #fff;
    }

    /* Sidebar */
    .pv-sidebar { position: sticky; top: 80px; }
    .pv-sidebar-cta {
      background: #faf8f5;
      padding: 24px;
      margin-bottom: 16px;
    }
    .pv-sidebar-cta h3 {
      font-size: 1.25rem;
      color: #1a1a1a;
      margin-bottom: 8px;
    }
    .pv-sidebar-cta p {
      font-size: 0.875rem;
      color: #888;
      margin-bottom: 16px;
      line-height: 1.6;
    }
    .pv-sidebar-cta-meta {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    .pv-sidebar-cta-meta p {
      font-size: 0.875rem;
      color: #1a1a1a;
      margin: 0 0 4px;
    }
    .pv-sidebar-info { background: #f9f7f4; padding: 24px; }
    .pv-sidebar-info-item { padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
    .pv-sidebar-info-item:last-child { border-bottom: none; }
    .pv-sidebar-info-label {
      font-size: 0.6875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #c2703e;
      margin-bottom: 4px;
    }
    .pv-sidebar-info-value { font-size: 0.9375rem; color: #1a1a1a; }

    /* Final CTA */
    .pv-final-cta {
      background: #faf8f5;
      padding: 80px 0;
      text-align: center;
    }
    .pv-final-cta h2 {
      font-family: 'Playfair Display', Georgia, serif;
      font-size: clamp(1.75rem, 4vw, 2.5rem);
      margin-bottom: 12px;
    }
    .pv-final-cta p { color: #888; max-width: 500px; margin: 0 auto 24px; }
    .pv-final-cta .pv-btn-primary { background: #1a1a1a; color: #fff; }

    /* Responsive */
    @media (max-width: 1024px) {
      .pv-grid { grid-template-columns: 1fr; }
      .pv-sidebar { position: static; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .pv-gallery-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .pv-hero-content { padding: 40px 0; }
      .pv-snapshot-grid { gap: 16px; }
      .pv-snapshot-icon { display: none; }
      .pv-accordion-panel { padding-left: 0; }
      .pv-sidebar { grid-template-columns: 1fr; }
    }

    /* Gallery Modal */
    .pv-gallery-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    .pv-gallery-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: none;
      border: none;
      color: #fff;
      font-size: 32px;
      cursor: pointer;
    }
    .pv-gallery-content {
      max-width: 1000px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .pv-gallery-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .pv-gallery-item {
      position: relative;
      aspect-ratio: 1;
      cursor: pointer;
      overflow: hidden;
      border-radius: 4px;
    }
    .pv-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .pv-gallery-video-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</body>
</html>
