<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Itinerary | NUBEAUX Creator Portal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">

  <style>
    :root {
      --color-bg: #fafafa;
      --color-white: #ffffff;
      --color-text: #1a1a1a;
      --color-text-light: #6b6b6b;
      --color-border: #e5e5e5;
      --color-accent: #c2703e;
      --color-accent-light: #f5ebe4;
      --color-success: #22c55e;
      --color-error: #ef4444;
      --font-sans: 'Inter', -apple-system, sans-serif;
      --font-serif: 'Playfair Display', Georgia, serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
    }

    /* Top Bar */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--color-white);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      z-index: 100;
    }

    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: transparent;
      font-size: 0.875rem;
      color: var(--color-text);
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }

    .back-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .top-bar-title {
      font-family: var(--font-serif);
      font-size: 1.125rem;
    }

    .top-bar-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
      border: none;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--color-border);
      color: var(--color-text);
    }

    .btn-outline:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .btn-primary {
      background: var(--color-accent);
      color: white;
    }

    .btn-primary:hover {
      background: #a85d32;
    }

    /* Main Layout */
    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      margin-top: 60px;
      min-height: calc(100vh - 60px);
    }

    .editor-main {
      padding: 32px 48px;
      max-width: 900px;
    }

    .editor-sidebar {
      background: var(--color-white);
      border-left: 1px solid var(--color-border);
      padding: 24px;
      position: sticky;
      top: 60px;
      height: calc(100vh - 60px);
      overflow-y: auto;
    }

    /* Form Styles */
    .form-section {
      margin-bottom: 40px;
    }

    .form-section-title {
      font-family: var(--font-serif);
      font-size: 1.25rem;
      font-weight: 400;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--color-border);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--color-text);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-size: 0.9375rem;
      font-family: var(--font-sans);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-light);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }

    /* AI Wand */
    .textarea-wrapper {
      position: relative;
    }

    .ai-wand-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 32px;
      height: 32px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-white);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 5;
    }

    .ai-wand-btn:hover {
      border-color: #8b5cf6;
      background: #f5f3ff;
    }

    .ai-wand-btn svg {
      width: 16px;
      height: 16px;
      color: #8b5cf6;
    }

    .ai-wand-btn.loading {
      pointer-events: none;
    }

    .ai-wand-btn.loading svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .ai-menu {
      position: absolute;
      top: 44px;
      right: 8px;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10;
      min-width: 180px;
      display: none;
    }

    .ai-menu.show {
      display: block;
    }

    .ai-menu-header {
      padding: 10px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-light);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .ai-menu-header svg {
      width: 12px;
      height: 12px;
      color: #8b5cf6;
    }

    .ai-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      font-size: 0.875rem;
      color: var(--color-text);
      cursor: pointer;
      text-align: left;
      transition: background 0.15s;
    }

    .ai-menu-item:hover {
      background: var(--color-bg);
    }

    .ai-menu-item svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-light);
    }

    .ai-menu-item:last-child {
      border-radius: 0 0 8px 8px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-hint {
      font-size: 0.8125rem;
      color: var(--color-text-light);
      margin-top: 6px;
    }

    /* Hero Image Upload */
    .hero-upload {
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .hero-upload:hover {
      border-color: var(--color-accent);
    }

    .hero-upload.has-image {
      padding: 0;
      border-style: solid;
    }

    .hero-upload img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .hero-upload-content {
      color: var(--color-text-light);
    }

    .hero-upload-content svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .hero-upload input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    /* Day Cards */
    .days-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .day-card {
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .day-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--color-bg);
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
    }

    .day-card-header h3 {
      font-size: 1rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .day-number {
      width: 28px;
      height: 28px;
      background: var(--color-accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .day-card-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-white);
      cursor: pointer;
      transition: all 0.2s;
    }

    .icon-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .icon-btn svg {
      width: 16px;
      height: 16px;
    }

    .day-card-content {
      padding: 20px;
    }

    /* Media Grid */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .media-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      cursor: pointer;
    }

    .media-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .media-item-add {
      border: 2px dashed var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-light);
      transition: all 0.2s;
    }

    .media-item-add:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .media-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .media-item:hover .media-item-remove {
      opacity: 1;
    }

    .media-item-remove svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    /* Gallery Grid */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .gallery-item {
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      background: var(--color-bg);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gallery-item-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .gallery-item:hover .gallery-item-remove {
      opacity: 1;
    }

    .gallery-item-remove svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .gallery-item-video::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.6) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpolygon points='5 3 19 12 5 21 5 3'/%3E%3C/svg%3E") center/50% no-repeat;
      border-radius: 50%;
    }

    /* Add Day Button */
    .add-day-btn {
      width: 100%;
      padding: 16px;
      border: 2px dashed var(--color-border);
      border-radius: 12px;
      background: transparent;
      color: var(--color-text-light);
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .add-day-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    /* Sidebar Sections */
    .sidebar-section {
      margin-bottom: 28px;
    }

    .sidebar-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-light);
      margin-bottom: 12px;
    }

    /* Tags Input */
    .tags-input {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      min-height: 44px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--color-accent-light);
      color: var(--color-accent);
      border-radius: 20px;
      font-size: 0.8125rem;
    }

    .tag button {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      line-height: 1;
    }

    .tags-input input {
      flex: 1;
      min-width: 80px;
      border: none;
      outline: none;
      font-size: 0.875rem;
      padding: 4px;
    }

    /* Preview Panel */
    .preview-card {
      background: var(--color-bg);
      border-radius: 8px;
      overflow: hidden;
    }

    .preview-card-image {
      height: 120px;
      background: var(--color-border);
    }

    .preview-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-card-content {
      padding: 16px;
    }

    .preview-card-content h4 {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .preview-card-content p {
      font-size: 0.8125rem;
      color: var(--color-text-light);
    }

    /* Status Badge */
    .status-toggle {
      display: flex;
      gap: 8px;
    }

    .status-option {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background: transparent;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .status-option.active {
      border-color: var(--color-accent);
      background: var(--color-accent-light);
      color: var(--color-accent);
    }

    .status-option[data-status="pending"].active {
      border-color: #8b5cf6;
      background: #f5f3ff;
      color: #7c3aed;
    }

    /* Stays List */
    .stays-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .stay-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      padding: 16px;
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      align-items: start;
    }

    .stay-item-fields {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stay-item-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stay-item .form-input {
      padding: 10px 12px;
      font-size: 0.875rem;
    }

    /* Hero image with preview */
    .hero-preview {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
    }

    .hero-preview img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .hero-preview-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
    }

    .hero-preview-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .hero-preview-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .hero-preview-btn svg {
      width: 18px;
      height: 18px;
      color: white;
    }

    .hero-focal-point {
      position: absolute;
      width: 36px;
      height: 36px;
      margin-left: -18px;
      margin-top: -18px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-accent);
      border-radius: 50%;
      cursor: move;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      transition: transform 0.1s;
    }

    .hero-focal-point:hover {
      transform: scale(1.1);
    }

    .hero-focal-point svg {
      width: 20px;
      height: 20px;
      color: var(--color-accent);
    }

    .hero-focal-hint {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.75rem;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .hero-preview:hover .hero-focal-hint {
      opacity: 1;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--color-text);
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--color-success);
    }

    /* Instagram Content Import */
    .ig-import-section {
      background: var(--color-white);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .ig-import-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      color: white;
    }

    .ig-import-header svg {
      width: 24px;
      height: 24px;
    }

    .ig-import-header h3 {
      font-size: 1rem;
      font-weight: 500;
    }

    .ig-import-body {
      padding: 20px;
    }

    .ig-url-input {
      width: 100%;
      min-height: 120px;
      padding: 12px 14px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: var(--font-sans);
      font-size: 0.875rem;
      resize: vertical;
      line-height: 1.8;
    }

    .ig-url-input:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px var(--color-accent-light);
    }

    .ig-url-input::placeholder {
      color: var(--color-text-light);
    }

    .ig-import-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
    }

    .ig-import-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
    }

    .ig-import-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .ig-import-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .ig-import-btn.secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
    }

    .ig-import-btn.secondary:hover {
      background: var(--color-surface-hover, #f5f5f5);
    }

    .ig-import-btn svg {
      width: 16px;
      height: 16px;
    }

    .ig-import-status {
      font-size: 0.8125rem;
      color: var(--color-text-light);
    }

    .ig-import-status.processing {
      color: #8b5cf6;
    }

    .ig-import-status.success {
      color: var(--color-success);
    }

    .ig-import-status.error {
      color: var(--color-error);
    }

    /* Imported Content Grid */
    .ig-content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--color-border);
    }

    .ig-content-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      background: var(--color-bg);
    }

    .ig-content-item img,
    .ig-content-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-content-item .video-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ig-content-item .video-indicator svg {
      width: 12px;
      height: 12px;
      color: white;
    }

    .ig-content-item .status-badge {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 4px 8px;
      font-size: 0.6875rem;
      text-align: center;
      color: white;
    }

    .ig-content-item .status-badge.pending {
      background: rgba(139, 92, 246, 0.9);
    }

    .ig-content-item .status-badge.processing {
      background: rgba(59, 130, 246, 0.9);
    }

    .ig-content-item .status-badge.ready {
      background: rgba(34, 197, 94, 0.9);
    }

    .ig-content-item .status-badge.failed {
      background: rgba(239, 68, 68, 0.9);
    }

    .ig-content-item .remove-btn {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .ig-content-item:hover .remove-btn {
      opacity: 1;
    }

    .ig-content-item .remove-btn svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .ig-content-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 24px;
      color: var(--color-text-light);
    }

    .ig-content-empty svg {
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      opacity: 0.4;
    }

    /* Synced Posts Grid */
    .ig-posts-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
      padding: 4px;
    }

    .ig-post-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s, transform 0.15s;
    }

    .ig-post-item:hover {
      transform: scale(1.02);
    }

    .ig-post-item.selected {
      border-color: var(--color-accent);
    }

    .ig-post-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-post-item .post-type-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .ig-post-item .post-type-badge svg {
      width: 10px;
      height: 10px;
    }

    .ig-post-item .post-select-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .ig-post-item .post-select-indicator.checked {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }

    .ig-post-item .post-select-indicator svg {
      width: 12px;
      height: 12px;
      color: transparent;
    }

    .ig-post-item .post-select-indicator.checked svg {
      color: white;
    }

    /* Highlights Grid */
    .ig-highlights-container {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .ig-highlight-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .ig-highlight-item:hover {
      transform: scale(1.05);
    }

    .ig-highlight-item .highlight-cover {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #F77737 100%);
    }

    .ig-highlight-item .highlight-cover img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid white;
    }

    .ig-highlight-item .highlight-title {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--color-text);
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: center;
    }

    .ig-highlight-item .highlight-count {
      font-size: 0.6875rem;
      color: var(--color-text-light);
    }

    /* Downloaded Stories Grid */
    .stories-import-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .stories-import-header span {
      font-size: 0.875rem;
      color: var(--color-text-light);
    }

    .stories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .ig-story-item {
      position: relative;
      aspect-ratio: 9/16;
      border-radius: 8px;
      overflow: hidden;
      background: var(--color-bg);
    }

    .ig-story-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .ig-story-item .story-type-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 20px;
      height: 20px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .ig-story-item .story-type-badge svg {
      width: 10px;
      height: 10px;
    }

    .ig-story-item {
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.15s;
    }

    .ig-story-item.selected {
      border-color: var(--color-accent);
    }

    .ig-story-item .post-select-indicator {
      position: absolute;
      bottom: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .ig-story-item.selected .post-select-indicator {
      background: var(--color-accent);
      border-color: var(--color-accent);
    }

    .ig-story-item .post-select-indicator svg {
      width: 12px;
      height: 12px;
      color: transparent;
    }

    .ig-story-item.selected .post-select-indicator svg {
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8125rem;
    }

    /* Stories Edit */
    .story-edit-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .story-edit-ring {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px solid var(--color-accent);
      padding: 2px;
      background: var(--color-white);
    }

    .story-edit-ring img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .story-edit-label {
      font-size: 0.75rem;
      color: var(--color-text-light);
    }

    .story-edit-empty {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 2px dashed var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-light);
    }

    @media (max-width: 1024px) {
      .editor-layout {
        grid-template-columns: 1fr;
      }
      .editor-sidebar {
        display: none;
      }
      .editor-main {
        padding: 24px;
      }
    }

    /* Sync Status Banner */
    .sync-banner {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #f5ebe4 0%, #fff4f0 100%);
      border-bottom: 1px solid var(--color-border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 99;
      font-size: 0.875rem;
    }

    .sync-banner.hidden {
      display: none;
    }

    .sync-banner .sync-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-border);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .sync-banner .sync-message {
      color: var(--color-text);
    }

    .sync-banner .sync-complete {
      color: #22c55e;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sync-banner:not(.hidden) + .editor-layout {
      margin-top: 108px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Sync Status Banner -->
  <div id="syncBanner" class="sync-banner hidden">
    <div class="sync-spinner" id="syncSpinner"></div>
    <span class="sync-message" id="syncMessage">Syncing your Instagram content...</span>
  </div>
  <!-- Top Bar -->
  <header class="top-bar">
    <div class="top-bar-left">
      <a href="index.html" class="back-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Back
      </a>
      <h1 class="top-bar-title" id="pageTitle">New Itinerary</h1>
    </div>
    <div class="top-bar-actions">
      <button class="btn btn-outline" id="previewBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        Preview
      </button>
      <button class="btn btn-primary" id="saveBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save
      </button>
    </div>
  </header>

  <div class="editor-layout">
    <main class="editor-main">
      <!-- Basic Info -->
      <section class="form-section">
        <h2 class="form-section-title">Basic Information</h2>

        <div class="form-group">
          <label class="form-label" for="title">Title</label>
          <input type="text" id="title" class="form-input" placeholder="e.g., Wilderness & Wonder">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="destination">Destination</label>
            <input type="text" id="destination" class="form-input" placeholder="e.g., Namibia">
          </div>
          <div class="form-group">
            <label class="form-label" for="location">Location</label>
            <input type="text" id="location" class="form-input" placeholder="e.g., Onguma, Etosha">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="duration">Duration</label>
          <input type="text" id="duration" class="form-input" placeholder="e.g., 4 days / 3 nights">
        </div>

        <div class="form-group">
          <label class="form-label" for="intro">Introduction</label>
          <div class="textarea-wrapper">
            <textarea id="intro" class="form-textarea" rows="4" placeholder="Write a personal introduction to this itinerary..." style="padding-right: 48px;"></textarea>
            <button type="button" class="ai-wand-btn" onclick="toggleAiMenu(this)" title="AI Enhance">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>
            </button>
            <div class="ai-menu">
              <div class="ai-menu-header">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M15 9h0M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/></svg>
                AI Enhance
              </div>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'improve')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                Improve Writing
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'shorten')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 12H7"/><path d="m11 8-4 4 4 4"/><path d="m13 8 4 4-4 4"/></svg>
                Make Shorter
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'expand')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12H3"/><path d="m15 6 6 6-6 6"/><path d="m9 6-6 6 6 6"/></svg>
                Expand & Add Detail
              </button>
              <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'personal')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                More Personal
              </button>
            </div>
          </div>
          <p class="form-hint">Tell travelers why you love this destination and what makes it special.</p>
        </div>
      </section>

      <!-- Hero Image -->
      <section class="form-section">
        <h2 class="form-section-title">Hero Image</h2>
        <div id="heroImageContainer">
          <div class="hero-upload" id="heroUpload">
            <div class="hero-upload-content">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              <p>Click to upload or drag image here</p>
              <p class="form-hint">Recommended: 1920x1080px</p>
            </div>
            <input type="file" accept="image/*" id="heroInput">
          </div>
        </div>
        <div class="form-group" style="margin-top: 12px;">
          <label class="form-label">Or paste image URL</label>
          <div style="display: flex; gap: 8px;">
            <input type="url" id="heroUrl" class="form-input" placeholder="https://...">
            <button type="button" class="btn btn-outline" onclick="loadHeroFromUrl()" style="white-space: nowrap;">Load URL</button>
          </div>
        </div>
      </section>

      <!-- Instagram Content -->
      <section class="form-section">
        <h2 class="form-section-title">Your Instagram Content</h2>
        <p class="form-hint" style="margin-bottom: 16px;">Sync your Instagram profile to import posts and stories for this itinerary.</p>

        <!-- Step 1: Profile Sync -->
        <div class="ig-import-section">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
              <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
              <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/>
            </svg>
            <h3>Step 1: Sync Your Profile</h3>
          </div>
          <div class="ig-import-body">
            <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
              <div style="position: relative; flex: 1; display: flex; align-items: center;">
                <span style="position: absolute; left: 12px; color: var(--color-text-light);">@</span>
                <input type="text" id="igProfileUrl" class="form-input" placeholder="Your verified Instagram" style="flex: 1; padding-left: 28px;">
                <span id="verifiedBadge" style="display: none; position: absolute; right: 12px; color: #28a745; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                  Verified
                </span>
              </div>
              <button type="button" class="ig-import-btn secondary" id="loadSavedBtn" onclick="loadSavedPosts()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Load Saved
              </button>
              <button type="button" class="ig-import-btn" id="syncProfileBtn" onclick="syncInstagramProfile()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
                </svg>
                Sync New
              </button>
            </div>
            <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 0.875rem; color: var(--color-text-light);">From:</label>
                <input type="date" id="igDateFrom" class="form-input" style="width: auto;">
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 0.875rem; color: var(--color-text-light);">To:</label>
                <input type="date" id="igDateTo" class="form-input" style="width: auto;">
              </div>
              <span style="font-size: 0.75rem; color: var(--color-text-light);">Load Saved = instant from database | Sync New = fetch from Instagram</span>
            </div>
            <span class="ig-import-status" id="syncProfileStatus"></span>

            <!-- Synced Posts Grid -->
            <div class="ig-posts-grid" id="igPostsGrid" style="display: none;">
              <p class="form-hint" style="margin-bottom: 12px;">Select posts to include in this itinerary:</p>
              <div class="ig-posts-container" id="igPostsContainer"></div>
              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllPosts()">Select All</button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="clearAllPosts()">Clear All</button>
                <button type="button" class="ig-import-btn" id="importSelectedBtn" onclick="importSelectedPosts()" style="display: none;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Import Selected (<span id="selectedCount">0</span>)
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Highlights/Stories -->
        <div class="ig-import-section" style="margin-top: 24px;">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <h3>Step 2: Import Story Highlights</h3>
          </div>
          <div class="ig-import-body">
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <button type="button" class="ig-import-btn secondary" id="loadSavedHighlightsBtn" onclick="loadSavedHighlights()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                </svg>
                Load Saved
              </button>
              <button type="button" class="ig-import-btn" id="getHighlightsBtn" onclick="getInstagramHighlights()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Sync New
              </button>
            </div>
            <span class="ig-import-status" id="highlightsStatus"></span>

            <!-- Highlights Grid -->
            <div class="ig-highlights-grid" id="igHighlightsGrid" style="display: none;">
              <p class="form-hint" style="margin-bottom: 12px;">Select a highlight to download its stories:</p>
              <div class="ig-highlights-container" id="igHighlightsContainer"></div>
            </div>

            <!-- Downloaded Stories -->
            <div class="ig-stories-grid" id="igStoriesGrid" style="display: none; margin-top: 16px;">
              <p class="form-hint" style="margin-bottom: 12px;">Stories from selected highlight:</p>
              <div class="ig-stories-container" id="igStoriesContainer"></div>
            </div>
          </div>
        </div>

        <!-- Imported Content Grid -->
        <div class="ig-import-section" style="margin-top: 24px;">
          <div class="ig-import-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <h3>Imported Content</h3>
          </div>
          <div class="ig-import-body">
            <div class="ig-content-grid" id="igContentGrid">
              <div class="ig-content-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <circle cx="8.5" cy="8.5" r="1.5"/>
                  <polyline points="21 15 16 10 5 21"/>
                </svg>
                <p>Imported content will appear here</p>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- AI Generate Itinerary -->
      <section class="form-section" id="generateSection" style="background: linear-gradient(135deg, #f8f4ff 0%, #fff4f0 100%); border-radius: 12px; padding: 24px;">
        <h2 class="form-section-title" style="display: flex; align-items: center; gap: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
            <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
            <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
            <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
          </svg>
          Generate Itinerary with AI
        </h2>
        <p class="form-hint" style="margin-bottom: 16px;">
          Import your content above, then let AI create a complete itinerary with title, introduction, and day-by-day organization.
        </p>

        <div class="form-row" style="margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label" for="numDays">Number of Days</label>
            <input type="number" id="numDays" class="form-input" min="1" max="30" value="4" style="width: 100px;">
          </div>
          <div class="form-group" style="flex: 2;">
            <label class="form-label" for="tripContext">Trip Context (optional)</label>
            <input type="text" id="tripContext" class="form-input" placeholder="e.g., Safari honeymoon, Family adventure, Solo backpacking...">
          </div>
        </div>

        <div style="display: flex; align-items: center; gap: 16px;">
          <button type="button" class="ig-import-btn" id="generateItineraryBtn" onclick="generateItineraryWithAI()" style="font-size: 1rem; padding: 14px 28px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
              <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
              <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
              <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
            </svg>
            Generate Itinerary
          </button>
          <span id="generateStatus" class="ig-import-status"></span>
        </div>
        <p class="form-hint" style="margin-top: 12px;">
          <strong>Imported content:</strong> <span id="importedContentCount">0</span> items ready
        </p>
      </section>

      <!-- Stays / Properties -->
      <section class="form-section">
        <h2 class="form-section-title">Where You Stayed</h2>
        <p class="form-hint" style="margin-bottom: 16px;">Add the properties/lodges you stayed at during this trip.</p>

        <div id="staysList" class="stays-list">
          <!-- Stays will be added here -->
        </div>

        <button type="button" class="add-day-btn" id="addStayBtn" onclick="addStay()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Property
        </button>
      </section>

      <!-- Day-by-Day -->
      <section class="form-section">
        <h2 class="form-section-title">Day-by-Day Itinerary</h2>

        <div class="days-list" id="daysList">
          <!-- Day cards will be added here -->
        </div>

        <button class="add-day-btn" id="addDayBtn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Day
        </button>
      </section>

      <!-- Gallery -->
      <section class="form-section">
        <h2 class="form-section-title">Gallery</h2>
        <p class="form-hint" style="margin-bottom: 12px;">These images will appear in the trip gallery (View Gallery button)</p>
        <div class="gallery-grid" id="galleryGrid">
          <!-- Gallery items will be added here -->
        </div>
        <button type="button" class="btn btn-secondary" onclick="addGalleryItem()" style="margin-top: 12px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Image
        </button>
      </section>
    </main>

    <aside class="editor-sidebar">
      <!-- Status -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Status</h3>
        <div class="status-toggle" style="flex-direction: column; gap: 8px;">
          <button class="status-option active" data-status="draft" style="flex: none;">Draft</button>
          <button class="status-option" data-status="pending" style="flex: none;">Submit for Approval</button>
        </div>
        <p class="form-hint" style="margin-top: 8px;">Itineraries require admin approval before going live.</p>
      </div>

      <!-- Best For -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Best For</h3>
        <div class="tags-input" id="bestForTags">
          <input type="text" placeholder="Add tag...">
        </div>
        <p class="form-hint" style="margin-top: 8px;">e.g., First safari, Photography, Couples</p>
      </div>

      <!-- Preview -->
      <div class="sidebar-section">
        <h3 class="sidebar-section-title">Preview</h3>
        <div class="preview-card">
          <div class="preview-card-image" id="previewImage">
            <img src="" alt="" style="display: none;">
          </div>
          <div class="preview-card-content">
            <h4 id="previewTitle">Untitled Itinerary</h4>
            <p id="previewMeta">Destination - Duration</p>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <span id="toastMessage">Saved successfully</span>
  </div>

  <script src="data.js"></script>
  <script>
    // Check auth
    const session = localStorage.getItem('nubeaux_creator_session');
    if (!session) {
      // Allow access for demo purposes
      // window.location.href = 'login.html';
    }

    // State
    let itineraryData = {
      id: '',
      title: '',
      destination: '',
      location: '',
      duration: '',
      priceFrom: 0,
      intro: '',
      heroImage: '',
      days: [],
      included: [],
      bestFor: [],
      bestTimeToVisit: {
        peakWildlife: '',
        bestWeather: ''
      },
      status: 'draft'
    };

    // Instagram sync state (declared early to avoid temporal dead zone)
    let syncedPosts = [];
    let selectedPostIds = new Set();
    let highlights = [];
    let downloadedStories = [];
    let selectedStoryIndices = new Set();
    let importedContent = [];

    let currentStatus = 'draft';

    // Elements
    const daysList = document.getElementById('daysList');
    const addDayBtn = document.getElementById('addDayBtn');
    const heroUpload = document.getElementById('heroUpload');
    const heroInput = document.getElementById('heroInput');
    const saveBtn = document.getElementById('saveBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    // Sync banner elements
    const syncBanner = document.getElementById('syncBanner');
    const syncSpinner = document.getElementById('syncSpinner');
    const syncMessage = document.getElementById('syncMessage');

    // Auto-fill verified Instagram
    // TODO: Re-enable lock after testing - remove editable flag
    const TESTING_MODE = true; // Set to false to lock Instagram input
    const sessionData = session ? JSON.parse(session) : null;
    const verifiedInstagram = sessionData?.instagram || localStorage.getItem('nubeaux_verified_instagram') ? JSON.parse(localStorage.getItem('nubeaux_verified_instagram') || '{}').username : null;

    if (verifiedInstagram) {
      const igProfileInput = document.getElementById('igProfileUrl');
      const verifiedBadge = document.getElementById('verifiedBadge');
      igProfileInput.value = verifiedInstagram;

      if (!TESTING_MODE) {
        // Lock the input in production
        igProfileInput.readOnly = true;
        igProfileInput.style.backgroundColor = '#f0fdf4';
        igProfileInput.style.borderColor = '#86efac';
        igProfileInput.style.cursor = 'not-allowed';
        igProfileInput.title = 'Verified Instagram account (cannot be changed)';
        if (verifiedBadge) {
          verifiedBadge.style.display = 'flex';
        }
      } else {
        // Testing mode - allow editing
        igProfileInput.title = 'Testing mode: You can change this';
      }
    }

    // Check and display sync status on page load
    checkSyncStatus();

    async function checkSyncStatus() {
      const session = JSON.parse(localStorage.getItem('nubeaux_creator_session') || '{}');
      const creatorId = session.creatorId;
      const syncStatus = session.sync_status;

      // If not logged in or already completed, don't show banner
      if (!creatorId || syncStatus === 'completed') {
        return;
      }

      // If syncing, show banner and start polling
      if (syncStatus === 'syncing') {
        showSyncBanner('Syncing your Instagram content...');
        pollSyncStatus();
        return;
      }

      // If pending and there's an Instagram handle, we might need to start sync
      if (syncStatus === 'pending' && session.instagram) {
        // Check if sync was started elsewhere
        if (window.SUPABASE_CONFIGURED) {
          try {
            const status = await NubeauxDB.getCreatorSyncStatus(creatorId);
            if (status && status.sync_status === 'syncing') {
              session.sync_status = 'syncing';
              localStorage.setItem('nubeaux_creator_session', JSON.stringify(session));
              showSyncBanner('Syncing your Instagram content...');
              pollSyncStatus();
            } else if (status && status.sync_status === 'completed') {
              session.sync_status = 'completed';
              session.last_synced_at = status.last_synced_at;
              localStorage.setItem('nubeaux_creator_session', JSON.stringify(session));
            }
          } catch (e) {
            console.error('Error checking sync status:', e);
          }
        }
      }
    }

    function showSyncBanner(message) {
      syncBanner.classList.remove('hidden');
      syncMessage.textContent = message;
      syncSpinner.style.display = 'block';
    }

    function hideSyncBanner() {
      syncBanner.classList.add('hidden');
    }

    function showSyncComplete() {
      syncSpinner.style.display = 'none';
      syncMessage.innerHTML = '<span class="sync-complete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Instagram content synced! Click "Load Saved" to use your posts and highlights.</span>';

      // Hide banner after 5 seconds
      setTimeout(() => {
        hideSyncBanner();
      }, 5000);
    }

    async function pollSyncStatus() {
      const session = JSON.parse(localStorage.getItem('nubeaux_creator_session') || '{}');
      const creatorId = session.creatorId;

      if (!creatorId || !window.SUPABASE_CONFIGURED) {
        return;
      }

      let attempts = 0;
      const maxAttempts = 60; // 5 minutes max (5s interval)

      const poll = async () => {
        attempts++;

        try {
          const status = await NubeauxDB.getCreatorSyncStatus(creatorId);

          if (status && status.sync_status === 'completed') {
            // Update session
            session.sync_status = 'completed';
            session.last_synced_at = status.last_synced_at;
            localStorage.setItem('nubeaux_creator_session', JSON.stringify(session));

            showSyncComplete();
            showToast('Instagram content synced successfully!', 'success');
            return;
          }

          if (status && status.sync_status === 'failed') {
            session.sync_status = 'failed';
            localStorage.setItem('nubeaux_creator_session', JSON.stringify(session));
            hideSyncBanner();
            showToast('Sync failed. Try "Sync New" to retry.', 'error');
            return;
          }

          // Still syncing - update message with progress
          const elapsed = attempts * 5;
          syncMessage.textContent = `Syncing your Instagram content... (${elapsed}s)`;

          // Continue polling if not exceeded max attempts
          if (attempts < maxAttempts) {
            setTimeout(poll, 5000);
          } else {
            hideSyncBanner();
            showToast('Sync is taking longer than expected. Check back later.');
          }
        } catch (error) {
          console.error('Error polling sync status:', error);
          if (attempts < maxAttempts) {
            setTimeout(poll, 5000);
          }
        }
      };

      // Start polling after initial delay
      setTimeout(poll, 5000);
    }

    // Load existing itinerary if editing
    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('id');

    if (editId && ITINERARIES[editId]) {
      loadItinerary(ITINERARIES[editId]);
      document.getElementById('pageTitle').textContent = ITINERARIES[editId].title || 'Edit Itinerary';
    } else {
      // Add first day by default
      addDay();
    }

    function loadItinerary(data) {
      itineraryData = { ...data };

      document.getElementById('title').value = data.title || '';
      document.getElementById('destination').value = data.destination || '';
      document.getElementById('location').value = data.location || '';
      document.getElementById('duration').value = data.duration || '';
      document.getElementById('intro').value = data.intro || '';

      // Hero image
      if (data.heroImage) {
        setHeroImage(data.heroImage);
      }

      // Status
      setStatus(data.status || 'draft');

      // Best For tags
      if (data.bestFor) {
        data.bestFor.forEach(tag => addTag('bestForTags', tag));
      }

      // Stays/Properties
      if (data.stays && data.stays.length > 0) {
        data.stays.forEach(stay => addStay(stay));
      }

      // Days
      if (data.days && data.days.length > 0) {
        data.days.forEach(day => addDay(day));
      }

      // Instagram content
      if (data.instagramContent) {
        loadImportedContent(data.instagramContent);
      }

      updatePreview();
      updateStoriesPreview();
    }

    // Update Stories Preview (section was removed, but keep function for compatibility)
    function updateStoriesPreview() {
      const storiesList = document.getElementById('storiesList');
      if (!storiesList) return; // Section was removed
      const days = Array.from(daysList.children);

      let html = '';
      days.forEach((dayCard, i) => {
        const dayNum = i + 1;
        const mediaItems = dayCard.querySelectorAll('.media-item:not(.media-item-add) img');
        const firstMedia = mediaItems.length > 0 ? mediaItems[0].src : null;

        if (firstMedia) {
          html += `
            <div class="story-edit-item">
              <div class="story-edit-ring">
                <img src="${firstMedia}" alt="Day ${dayNum}">
              </div>
              <span class="story-edit-label">Day ${dayNum}</span>
            </div>
          `;
        } else {
          html += `
            <div class="story-edit-item">
              <div class="story-edit-empty">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              </div>
              <span class="story-edit-label">Day ${dayNum}</span>
            </div>
          `;
        }
      });

      storiesList.innerHTML = html || '<p style="color: var(--color-text-light);">Add days and media below to see story previews</p>';
    }

    // Add Day
    function addDay(dayData = null) {
      const dayNum = daysList.children.length + 1;
      const day = dayData || {
        dayNumber: dayNum,
        title: '',
        description: '',
        activities: [],
        media: []
      };

      const dayCard = document.createElement('div');
      dayCard.className = 'day-card';
      dayCard.dataset.dayNum = dayNum;
      dayCard.innerHTML = `
        <div class="day-card-header">
          <h3>
            <span class="day-number">${dayNum}</span>
            <input type="text" class="form-input" style="border: none; padding: 0; font-weight: 500;" placeholder="Day title..." value="${day.title || ''}">
          </h3>
          <div class="day-card-actions">
            <button class="icon-btn" onclick="toggleDayCard(this)" title="Collapse">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <button class="icon-btn" onclick="removeDay(this)" title="Remove">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
        <div class="day-card-content">
          <div class="form-group">
            <label class="form-label">Description</label>
            <div class="textarea-wrapper">
              <textarea class="form-textarea day-description" rows="4" placeholder="Describe this day from your personal experience..." style="padding-right: 48px;">${day.description || ''}</textarea>
              <button type="button" class="ai-wand-btn" onclick="toggleAiMenu(this)" title="AI Enhance">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>
              </button>
              <div class="ai-menu">
                <div class="ai-menu-header">
                  <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8L19 13M15 9h0M17.8 6.2L19 5M3 21l9-9M12.2 6.2L11 5"/></svg>
                  AI Enhance
                </div>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'improve')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                  Improve Writing
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'shorten')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 12H7"/><path d="m11 8-4 4 4 4"/><path d="m13 8 4 4-4 4"/></svg>
                  Make Shorter
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'expand')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12H3"/><path d="m15 6 6 6-6 6"/><path d="m9 6-6 6 6 6"/></svg>
                  Expand & Add Detail
                </button>
                <button type="button" class="ai-menu-item" onclick="enhanceText(this, 'personal')">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                  More Personal
                </button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Activities</label>
            <input type="text" class="form-input day-activities" placeholder="e.g., Morning Game Drive, Pool, Sundowners" value="${(day.activities || []).join(', ')}">
          </div>
        </div>
      `;

      daysList.appendChild(dayCard);
      updateStoriesPreview();
    }

    function toggleDayCard(btn) {
      const card = btn.closest('.day-card');
      const content = card.querySelector('.day-card-content');
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
      btn.querySelector('svg').style.transform = content.style.display === 'none' ? 'rotate(-90deg)' : '';
    }

    function removeDay(btn) {
      if (daysList.children.length <= 1) {
        showToast('You need at least one day');
        return;
      }
      btn.closest('.day-card').remove();
      // Renumber days
      Array.from(daysList.children).forEach((card, i) => {
        card.dataset.dayNum = i + 1;
        card.querySelector('.day-number').textContent = i + 1;
      });
      updateStoriesPreview();
    }

    addDayBtn.addEventListener('click', () => addDay());

    // Hero Image
    const heroContainer = document.getElementById('heroImageContainer');
    heroInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => setHeroImage(e.target.result);
        reader.readAsDataURL(file);
      }
    });

    function setHeroImage(src, focalX = 50, focalY = 50) {
      heroContainer.innerHTML = `
        <div class="hero-preview" id="heroPreviewContainer">
          <img src="${src}" alt="Hero" style="object-position: ${focalX}% ${focalY}%;" id="heroImg">
          <div class="hero-focal-point" id="heroFocalPoint" style="left: ${focalX}%; top: ${focalY}%;" title="Drag to adjust focal point">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
          </div>
          <div class="hero-focal-hint">Drag crosshair to set focal point</div>
          <div class="hero-preview-actions">
            <button type="button" class="hero-preview-btn" onclick="changeHeroImage()" title="Change Image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </button>
            <button type="button" class="hero-preview-btn" onclick="removeHeroImage()" title="Remove Image">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </div>
      `;
      itineraryData.heroImage = src;
      itineraryData.heroFocalX = focalX;
      itineraryData.heroFocalY = focalY;
      updatePreview();
      initHeroFocalDrag();
    }

    function initHeroFocalDrag() {
      const container = document.getElementById('heroPreviewContainer');
      const focalPoint = document.getElementById('heroFocalPoint');
      const heroImg = document.getElementById('heroImg');
      if (!container || !focalPoint) return;

      let isDragging = false;

      const updateFocalPoint = (e) => {
        const rect = container.getBoundingClientRect();
        let x = ((e.clientX - rect.left) / rect.width) * 100;
        let y = ((e.clientY - rect.top) / rect.height) * 100;

        // Clamp values
        x = Math.max(0, Math.min(100, x));
        y = Math.max(0, Math.min(100, y));

        focalPoint.style.left = x + '%';
        focalPoint.style.top = y + '%';
        heroImg.style.objectPosition = `${x}% ${y}%`;

        itineraryData.heroFocalX = x;
        itineraryData.heroFocalY = y;
      };

      focalPoint.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.preventDefault();
      });

      container.addEventListener('click', (e) => {
        if (e.target.closest('.hero-preview-actions')) return;
        updateFocalPoint(e);
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging) {
          updateFocalPoint(e);
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
    }

    function changeHeroImage() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => setHeroImage(e.target.result);
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function removeHeroImage() {
      heroContainer.innerHTML = `
        <div class="hero-upload" id="heroUpload">
          <div class="hero-upload-content">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            <p>Click to upload or drag image here</p>
            <p class="form-hint">Recommended: 1920x1080px</p>
          </div>
          <input type="file" accept="image/*" id="heroInput">
        </div>
      `;
      document.getElementById('heroInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => setHeroImage(ev.target.result);
          reader.readAsDataURL(file);
        }
      });
      itineraryData.heroImage = '';
      updatePreview();
    }

    function loadHeroFromUrl() {
      const url = document.getElementById('heroUrl').value.trim();
      if (!url) {
        showToast('Please enter an image URL');
        return;
      }
      // Test if URL is valid image
      const img = new Image();
      img.onload = () => {
        setHeroImage(url);
        document.getElementById('heroUrl').value = '';
        showToast('Image loaded successfully', 'success');
      };
      img.onerror = () => {
        showToast('Could not load image from URL');
      };
      img.src = url;
    }

    // Stays / Properties
    const staysList = document.getElementById('staysList');

    function addStay(stayData = null) {
      const stay = stayData || { name: '', location: '', nights: '', notes: '' };
      const stayItem = document.createElement('div');
      stayItem.className = 'stay-item';
      stayItem.innerHTML = `
        <div class="stay-item-fields">
          <input type="text" class="form-input stay-name" placeholder="Property name (e.g., Onguma The Fort)" value="${stay.name || ''}">
          <div class="stay-item-row">
            <input type="text" class="form-input stay-location" placeholder="Location" value="${stay.location || ''}">
            <input type="text" class="form-input stay-nights" placeholder="Nights stayed" value="${stay.nights || ''}">
          </div>
          <input type="text" class="form-input stay-notes" placeholder="Notes (optional)" value="${stay.notes || ''}">
        </div>
        <button type="button" class="icon-btn" onclick="this.closest('.stay-item').remove()" title="Remove">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      `;
      staysList.appendChild(stayItem);
    }

    // Tags
    function addTag(containerId, tagText) {
      const container = document.getElementById(containerId);
      const input = container.querySelector('input');
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.innerHTML = `${tagText} <button onclick="this.parentElement.remove()">&times;</button>`;
      container.insertBefore(tag, input);
    }

    document.getElementById('bestForTags').querySelector('input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        addTag('bestForTags', e.target.value.trim());
        e.target.value = '';
      }
    });

    // Status toggle
    document.querySelectorAll('.status-option').forEach(btn => {
      btn.addEventListener('click', () => setStatus(btn.dataset.status));
    });

    function setStatus(status) {
      currentStatus = status;
      document.querySelectorAll('.status-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.status === status);
      });
    }

    // Preview updates
    ['title', 'destination', 'duration'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePreview);
    });

    function updatePreview() {
      const title = document.getElementById('title').value || 'Untitled Itinerary';
      const destination = document.getElementById('destination').value || 'Destination';
      const duration = document.getElementById('duration').value || 'Duration';

      document.getElementById('previewTitle').textContent = title;
      document.getElementById('previewMeta').textContent = `${destination} - ${duration}`;

      const previewImg = document.querySelector('#previewImage img');
      if (itineraryData.heroImage) {
        previewImg.src = itineraryData.heroImage;
        previewImg.style.display = 'block';
      }
    }

    // Media
    function addMedia(btn) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const mediaItem = document.createElement('div');
            mediaItem.className = 'media-item';
            mediaItem.innerHTML = `
              <img src="${e.target.result}" alt="">
              <div class="media-item-remove" onclick="removeMedia(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
              </div>
            `;
            btn.parentElement.insertBefore(mediaItem, btn);
            updateStoriesPreview();
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function removeMedia(btn) {
      btn.closest('.media-item').remove();
      updateStoriesPreview();
    }

    // Gallery functions
    function addGalleryItem(imageUrl = null, isVideo = false) {
      const grid = document.getElementById('galleryGrid');

      if (imageUrl) {
        // Add from URL (e.g., from imported content)
        const item = document.createElement('div');
        item.className = 'gallery-item' + (isVideo ? ' gallery-item-video' : '');
        item.innerHTML = `
          <img src="${imageUrl}" alt="">
          <div class="gallery-item-remove" onclick="removeGalleryItem(this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </div>
        `;
        grid.appendChild(item);
      } else {
        // Add from file picker
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*,video/*';
        input.multiple = true;
        input.onchange = (e) => {
          Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
              const item = document.createElement('div');
              item.className = 'gallery-item' + (file.type.startsWith('video') ? ' gallery-item-video' : '');
              item.innerHTML = `
                <img src="${ev.target.result}" alt="">
                <div class="gallery-item-remove" onclick="removeGalleryItem(this)">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </div>
              `;
              grid.appendChild(item);
            };
            reader.readAsDataURL(file);
          });
        };
        input.click();
      }
    }

    function removeGalleryItem(btn) {
      btn.closest('.gallery-item').remove();
    }

    function clearGallery() {
      document.getElementById('galleryGrid').innerHTML = '';
    }

    function populateGallery(items) {
      clearGallery();
      items.forEach(item => {
        addGalleryItem(item.url || item.thumbnail_url, item.type === 'video' || item.type === 'Video');
      });
    }

    // Save
    saveBtn.addEventListener('click', async () => {
      // Gather data
      itineraryData.title = document.getElementById('title').value?.trim() || '';
      itineraryData.destination = document.getElementById('destination').value?.trim() || '';
      itineraryData.location = document.getElementById('location').value?.trim() || '';
      itineraryData.duration = document.getElementById('duration').value?.trim() || '';
      itineraryData.intro = document.getElementById('intro').value?.trim() || '';
      itineraryData.status = currentStatus;

      // Validate required fields
      if (!itineraryData.title) {
        showToast('Please enter a title for your itinerary', 'error');
        document.getElementById('title').focus();
        return;
      }

      // Instagram content
      itineraryData.instagramContent = getImportedContentForSave();

      // Gather stays
      itineraryData.stays = Array.from(staysList.children).map(item => ({
        name: item.querySelector('.stay-name')?.value || '',
        location: item.querySelector('.stay-location')?.value || '',
        nights: item.querySelector('.stay-nights')?.value || '',
        notes: item.querySelector('.stay-notes')?.value || ''
      })).filter(s => s.name);

      // Best for tags
      itineraryData.bestFor = Array.from(document.querySelectorAll('#bestForTags .tag'))
        .map(t => t.textContent.trim().replace('', '').trim());

      // Days
      itineraryData.days = Array.from(daysList.children).map((card, i) => ({
        dayNumber: i + 1,
        title: card.querySelector('.day-card-header input')?.value || '',
        description: card.querySelector('.day-description')?.value || '',
        activities: (card.querySelector('.day-activities')?.value || '').split(',').map(a => a.trim()).filter(a => a),
        media: Array.from(card.querySelectorAll('.media-item:not(.media-item-add) img'))
          .map(img => ({ type: 'image', url: img.src }))
      }));

      // Get creator ID from session
      const creatorId = getCreatorId();
      if (!creatorId) {
        showToast('You must be logged in to save', 'error');
        return;
      }

      // Show saving state
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        // Save to Supabase
        const response = await fetch('/.netlify/functions/save-itinerary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: itineraryData.id || null,
            creator_id: creatorId,
            title: itineraryData.title,
            destination: itineraryData.destination,
            region: itineraryData.location, // location maps to region
            duration: itineraryData.duration,
            hero_image: itineraryData.heroImage || null,
            intro: itineraryData.intro,
            days: itineraryData.days,
            stays: itineraryData.stays,
            included: itineraryData.included,
            status: itineraryData.status
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update local ID if it was generated
          if (result.itinerary?.id) {
            itineraryData.id = result.itinerary.id;
          }

          // Also save to localStorage as backup
          const savedItineraries = JSON.parse(localStorage.getItem('nubeaux_itineraries') || '{}');
          savedItineraries[itineraryData.id] = itineraryData;
          localStorage.setItem('nubeaux_itineraries', JSON.stringify(savedItineraries));

          showToast('Itinerary saved successfully!', 'success');
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to save: ' + error.message, 'error');
      } finally {
        // Restore button
        saveBtn.disabled = false;
        saveBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        `;
      }
    });

    // Preview button - shows modal preview without requiring save
    document.getElementById('previewBtn').addEventListener('click', () => {
      showPreviewModal();
    });

    // AI Wand Functions
    function toggleAiMenu(btn) {
      // Close all other menus
      document.querySelectorAll('.ai-menu.show').forEach(menu => {
        if (menu !== btn.nextElementSibling) {
          menu.classList.remove('show');
        }
      });
      // Toggle this menu
      const menu = btn.nextElementSibling;
      menu.classList.toggle('show');
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.textarea-wrapper')) {
        document.querySelectorAll('.ai-menu.show').forEach(menu => {
          menu.classList.remove('show');
        });
      }
    });

    async function enhanceText(btn, action) {
      const wrapper = btn.closest('.textarea-wrapper');
      const textarea = wrapper.querySelector('textarea');
      const wandBtn = wrapper.querySelector('.ai-wand-btn');
      const menu = wrapper.querySelector('.ai-menu');
      const originalText = textarea.value.trim();

      if (!originalText) {
        showToast('Please enter some text first');
        menu.classList.remove('show');
        return;
      }

      // Show loading state
      wandBtn.classList.add('loading');
      wandBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>';
      menu.classList.remove('show');

      // Simulate AI processing (replace with actual API call later)
      await new Promise(resolve => setTimeout(resolve, 1500));

      let enhancedText = originalText;

      // Demo transformations (will be replaced with real AI)
      switch (action) {
        case 'improve':
          enhancedText = improveWriting(originalText);
          break;
        case 'shorten':
          enhancedText = shortenText(originalText);
          break;
        case 'expand':
          enhancedText = expandText(originalText);
          break;
        case 'personal':
          enhancedText = makePersonal(originalText);
          break;
      }

      // Update textarea with animation
      textarea.style.opacity = '0.5';
      setTimeout(() => {
        textarea.value = enhancedText;
        textarea.style.opacity = '1';
      }, 150);

      // Reset button
      wandBtn.classList.remove('loading');
      wandBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/></svg>';

      showToast('Text enhanced!', 'success');
    }

    // Demo text transformations (placeholders for real AI)
    function improveWriting(text) {
      // Simple demo: capitalize first letter of sentences, clean up spacing
      return text
        .split('. ')
        .map(s => s.charAt(0).toUpperCase() + s.slice(1))
        .join('. ')
        .replace(/\s+/g, ' ')
        .trim() + (text.endsWith('.') ? '' : '.');
    }

    function shortenText(text) {
      // Demo: take first 60% of text
      const sentences = text.split('. ');
      const keep = Math.max(1, Math.ceil(sentences.length * 0.6));
      return sentences.slice(0, keep).join('. ') + '.';
    }

    function expandText(text) {
      // Demo: add descriptive phrases
      const additions = [
        ' The experience was truly unforgettable.',
        ' Every moment felt magical.',
        ' This is what travel dreams are made of.',
        ' I found myself completely immersed in the moment.'
      ];
      const randomAddition = additions[Math.floor(Math.random() * additions.length)];
      return text + (text.endsWith('.') ? '' : '.') + randomAddition;
    }

    function makePersonal(text) {
      // Demo: add personal touch
      const personalPhrases = ['I remember', 'For me,', 'What struck me most was that', 'I loved how'];
      const randomPhrase = personalPhrases[Math.floor(Math.random() * personalPhrases.length)];
      if (!text.toLowerCase().startsWith('i ')) {
        return randomPhrase + ' ' + text.charAt(0).toLowerCase() + text.slice(1);
      }
      return text;
    }

    // Toast
    function showToast(message, type = '') {
      toastMessage.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Instagram Content Import
    function parseInstagramUrls(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      const urlPattern = /instagram\.com\/(p|reel|tv)\/([A-Za-z0-9_-]+)/;
      const validUrls = [];

      lines.forEach(line => {
        const match = line.match(urlPattern);
        if (match) {
          validUrls.push({
            url: line,
            type: match[1], // p, reel, or tv
            shortcode: match[2]
          });
        }
      });

      return validUrls;
    }

    async function importInstagramContent() {
      const textarea = document.getElementById('igUrls');
      const importBtn = document.getElementById('importIgBtn');
      const statusEl = document.getElementById('igImportStatus');
      const urls = parseInstagramUrls(textarea.value);

      if (urls.length === 0) {
        showToast('Please enter valid Instagram URLs');
        return;
      }

      // Disable button and show processing state
      importBtn.disabled = true;
      importBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Importing...
      `;
      statusEl.textContent = `Processing ${urls.length} URL${urls.length > 1 ? 's' : ''}...`;
      statusEl.className = 'ig-import-status processing';

      try {
        // Call the Netlify function to scrape Instagram content
        const response = await fetch('/.netlify/functions/scrape-instagram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            urls: urls.map(u => u.url),
            creator_id: JSON.parse(localStorage.getItem('nubeaux_creator_session') || '{}').id || 'demo'
          })
        });

        const result = await response.json();

        if (result.success) {
          // Add to imported content
          result.content.forEach(item => {
            importedContent.push(item);
          });
          renderImportedContent();
          textarea.value = '';
          statusEl.textContent = `${result.content.length} item${result.content.length > 1 ? 's' : ''} imported`;
          statusEl.className = 'ig-import-status success';
          showToast('Content imported successfully!', 'success');
        } else {
          throw new Error(result.error || 'Import failed');
        }
      } catch (error) {
        console.error('Import error:', error);

        // For demo/development: simulate import with pending status
        urls.forEach(urlData => {
          importedContent.push({
            id: 'temp-' + Date.now() + '-' + urlData.shortcode,
            instagram_url: urlData.url,
            instagram_shortcode: urlData.shortcode,
            content_type: urlData.type === 'reel' ? 'Video' : 'Image',
            thumbnail_url: null, // Will be populated by backend
            status: 'pending',
            caption: ''
          });
        });
        renderImportedContent();
        textarea.value = '';
        statusEl.textContent = `${urls.length} item${urls.length > 1 ? 's' : ''} queued for processing`;
        statusEl.className = 'ig-import-status processing';
        showToast('Content queued - backend processing required', 'success');
      }

      // Reset button
      importBtn.disabled = false;
      importBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Import Content
      `;
    }

    function renderImportedContent() {
      const grid = document.getElementById('igContentGrid');

      if (importedContent.length === 0) {
        grid.innerHTML = `
          <div class="ig-content-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <p>Imported content will appear here</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = importedContent.map((item, index) => {
        const isVideo = item.content_type === 'Video' || item.content_type === 'Sidecar';
        const thumbnailSrc = item.thumbnail_url || item.cloudinary_url || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23e5e5e5" width="100" height="100"/%3E%3Ctext fill="%236b6b6b" font-family="sans-serif" font-size="12" x="50%" y="50%" text-anchor="middle" dy=".3em"%3EProcessing%3C/text%3E%3C/svg%3E';

        return `
          <div class="ig-content-item" data-index="${index}" data-shortcode="${item.instagram_shortcode}">
            <img src="${thumbnailSrc}" alt="${item.caption || 'Instagram content'}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e5e5e5%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%236b6b6b%22 font-family=%22sans-serif%22 font-size=%2212%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3EPending%3C/text%3E%3C/svg%3E'">
            ${isVideo ? `
              <div class="video-indicator">
                <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
              </div>
            ` : ''}
            <div class="status-badge ${item.status}">${item.status}</div>
            <button type="button" class="remove-btn" onclick="removeImportedContent(${index})" title="Remove">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        `;
      }).join('');

      // Update count display
      const countEl = document.getElementById('importedContentCount');
      if (countEl) countEl.textContent = importedContent.length;
    }

    function removeImportedContent(index) {
      importedContent.splice(index, 1);
      renderImportedContent();
      showToast('Content removed');
    }

    // Load existing imported content if editing
    function loadImportedContent(content) {
      if (content && Array.isArray(content)) {
        importedContent = content;
        renderImportedContent();
      }
    }

    // Include imported content in save
    function getImportedContentForSave() {
      return importedContent.map(item => ({
        instagram_shortcode: item.instagram_shortcode,
        instagram_url: item.instagram_url,
        content_type: item.content_type,
        cloudinary_url: item.cloudinary_url,
        cloudinary_video_url: item.cloudinary_video_url,
        thumbnail_url: item.thumbnail_url,
        caption: item.caption,
        status: item.status
      }));
    }

    // ===========================================
    // Instagram Profile Sync Functions (Apify)
    // ===========================================

    // Get creator ID from session
    function getCreatorId() {
      const session = JSON.parse(localStorage.getItem('nubeaux_creator_session') || '{}');
      return session.id || 'demo';
    }

    // Extract username from profile URL
    function extractUsername(url) {
      const match = url.match(/instagram\.com\/([A-Za-z0-9._]+)/);
      if (match) {
        const reserved = ['p', 'reel', 'tv', 'stories', 'explore', 'accounts', 'direct'];
        if (!reserved.includes(match[1].toLowerCase())) {
          return match[1];
        }
      }
      if (/^[A-Za-z0-9._]+$/.test(url)) {
        return url;
      }
      return null;
    }

    // Load saved posts from database (instant, no scraping)
    async function loadSavedPosts() {
      const loadBtn = document.getElementById('loadSavedBtn');
      const statusEl = document.getElementById('syncProfileStatus');
      const postsGrid = document.getElementById('igPostsGrid');

      // Get date filters
      const dateFromInput = document.getElementById('igDateFrom');
      const dateToInput = document.getElementById('igDateTo');
      const dateFrom = dateFromInput.value || null;
      const dateTo = dateToInput.value || null;

      // Show loading state
      loadBtn.disabled = true;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Loading...
      `;
      statusEl.textContent = 'Loading saved posts...';
      statusEl.className = 'ig-import-status processing';

      try {
        const response = await fetch('/.netlify/functions/sync-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'load',
            creator_id: getCreatorId(),
            date_from: dateFrom,
            date_to: dateTo
          })
        });

        const result = await response.json();

        if (result.success) {
          syncedPosts = result.posts || [];
          selectedPostIds.clear();
          renderSyncedPosts();
          postsGrid.style.display = 'block';
          statusEl.textContent = `Loaded ${syncedPosts.length} saved posts${dateFrom || dateTo ? ' (filtered by date)' : ''}`;
          statusEl.className = 'ig-import-status success';
        } else {
          throw new Error(result.error || 'Failed to load posts');
        }
      } catch (error) {
        console.error('Load posts error:', error);
        statusEl.textContent = 'Failed to load: ' + error.message;
        statusEl.className = 'ig-import-status error';
      }

      // Reset button
      loadBtn.disabled = false;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Load Saved
      `;
    }

    // Step 1: Sync Instagram Profile Posts (fetch new from Instagram)
    async function syncInstagramProfile() {
      const profileInput = document.getElementById('igProfileUrl');
      const syncBtn = document.getElementById('syncProfileBtn');
      const statusEl = document.getElementById('syncProfileStatus');
      const postsGrid = document.getElementById('igPostsGrid');
      const postsContainer = document.getElementById('igPostsContainer');

      const profileUrl = profileInput.value.trim();
      if (!profileUrl) {
        showToast('Please enter your Instagram profile URL');
        return;
      }

      const username = extractUsername(profileUrl);
      if (!username) {
        showToast('Invalid Instagram profile URL');
        return;
      }

      // Show loading state
      syncBtn.disabled = true;
      syncBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Starting sync...
      `;
      statusEl.textContent = 'Starting Instagram scraper...';
      statusEl.className = 'ig-import-status processing';

      try {
        // Get date filters from inputs (if set)
        const dateFromInput = document.getElementById('igDateFrom');
        const dateToInput = document.getElementById('igDateTo');
        const dateFrom = dateFromInput.value || null;
        const dateTo = dateToInput.value || null;

        // Step 1: Start the sync (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/sync-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profile_url: profileUrl,
            creator_id: getCreatorId(),
            date_from: dateFrom,
            date_to: dateTo
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success) {
          throw new Error(startResult.error || 'Failed to start sync');
        }

        const runId = startResult.run_id;
        statusEl.textContent = `Scraping @${username}... This may take 1-2 minutes.`;
        syncBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Scraping @${username}...
        `;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes max (5 sec intervals)

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
          attempts++;

          const pollResponse = await fetch('/.netlify/functions/sync-profile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              creator_id: getCreatorId(),
              date_to: dateTo
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            // Success! Show the posts
            syncedPosts = pollResult.posts || [];
            selectedPostIds.clear();
            renderSyncedPosts();
            postsGrid.style.display = 'block';
            statusEl.textContent = `Found ${syncedPosts.length} posts from @${username}`;
            statusEl.className = 'ig-import-status success';
            showToast(`Synced ${syncedPosts.length} posts!`, 'success');
            break;
          } else if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Scraping failed');
          } else {
            // Still processing - update status
            statusEl.textContent = `Scraping @${username}... (${attempts * 5}s)`;
          }
        }

        if (attempts >= maxAttempts) {
          throw new Error('Sync timed out after 5 minutes');
        }

      } catch (error) {
        console.error('Profile sync error:', error);
        statusEl.textContent = 'Sync failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to sync profile: ' + error.message);
      }

      // Reset button
      syncBtn.disabled = false;
      syncBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/>
        </svg>
        Sync Posts
      `;
    }

    // Render synced posts grid
    function renderSyncedPosts() {
      const container = document.getElementById('igPostsContainer');
      const importBtn = document.getElementById('importSelectedBtn');

      if (syncedPosts.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No posts found</p>';
        importBtn.style.display = 'none';
        return;
      }

      container.innerHTML = syncedPosts.map(post => {
        const shortcode = post.shortcode || post.shortCode;
        const isSelected = selectedPostIds.has(shortcode);
        const isVideo = post.post_type === 'Video' || post.video_url;
        const isCarousel = post.post_type === 'Sidecar';

        // thumbnail_url now contains Cloudinary URL (uploaded during sync)
        // Fallback to display_url if thumbnail_url not available
        const cloudinaryUrl = post.thumbnail_url;
        const placeholderUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23e5e5e5" width="100" height="100"/%3E%3C/svg%3E';
        const thumbnailSrc = cloudinaryUrl || placeholderUrl;

        return `
          <div class="ig-post-item ${isSelected ? 'selected' : ''}"
               data-shortcode="${shortcode}"
               onclick="togglePostSelection('${shortcode}')">
            <img src="${thumbnailSrc}" alt="${post.caption ? post.caption.substring(0, 50) : 'Instagram post'}"
                 onerror="this.src='${placeholderUrl}'">
            ${isVideo ? '<div class="post-type-badge video"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>' : ''}
            ${isCarousel ? '<div class="post-type-badge carousel"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M21 12H9"/></svg></div>' : ''}
            <div class="post-select-indicator ${isSelected ? 'checked' : ''}">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
          </div>
        `;
      }).join('');

      updateSelectedCount();
    }

    // Toggle post selection
    function togglePostSelection(shortcode) {
      if (selectedPostIds.has(shortcode)) {
        selectedPostIds.delete(shortcode);
      } else {
        selectedPostIds.add(shortcode);
      }

      // Update UI
      const item = document.querySelector(`.ig-post-item[data-shortcode="${shortcode}"]`);
      if (item) {
        item.classList.toggle('selected', selectedPostIds.has(shortcode));
        const indicator = item.querySelector('.post-select-indicator');
        if (indicator) {
          indicator.classList.toggle('checked', selectedPostIds.has(shortcode));
        }
      }

      updateSelectedCount();
    }

    // Select all posts
    function selectAllPosts() {
      syncedPosts.forEach(post => {
        const shortcode = post.shortcode || post.shortCode;
        if (shortcode) {
          selectedPostIds.add(shortcode);
        }
      });
      updatePostSelectionUI();
    }

    // Clear all post selections
    function clearAllPosts() {
      selectedPostIds.clear();
      updatePostSelectionUI();
    }

    // Update all post selection UI
    function updatePostSelectionUI() {
      document.querySelectorAll('.ig-post-item').forEach(item => {
        const shortcode = item.dataset.shortcode;
        const isSelected = selectedPostIds.has(shortcode);
        item.classList.toggle('selected', isSelected);
        const indicator = item.querySelector('.post-select-indicator');
        if (indicator) {
          indicator.classList.toggle('checked', isSelected);
        }
      });
      updateSelectedCount();
    }

    // Update selected count
    function updateSelectedCount() {
      const countEl = document.getElementById('selectedCount');
      const importBtn = document.getElementById('importSelectedBtn');
      countEl.textContent = selectedPostIds.size;
      importBtn.style.display = selectedPostIds.size > 0 ? 'inline-flex' : 'none';
    }

    // Import selected posts to itinerary
    async function importSelectedPosts() {
      if (selectedPostIds.size === 0) {
        showToast('Please select posts to import');
        return;
      }

      // Handle both shortcode and shortCode (API returns camelCase, DB returns snake_case)
      const selectedPosts = syncedPosts.filter(p => {
        const code = p.shortcode || p.shortCode;
        return selectedPostIds.has(code);
      });

      // Add to imported content
      selectedPosts.forEach(post => {
        const shortcode = post.shortcode || post.shortCode;
        // Check if already imported
        const alreadyImported = importedContent.some(c => c.instagram_shortcode === shortcode);
        if (!alreadyImported) {
          importedContent.push({
            id: post.id,
            instagram_url: `https://instagram.com/p/${shortcode}`,
            instagram_shortcode: shortcode,
            content_type: post.post_type || 'Image',
            thumbnail_url: post.thumbnail_url || post.display_url,
            cloudinary_url: post.display_url,
            cloudinary_video_url: post.video_url,
            caption: post.caption,
            status: 'ready'
          });
        }
      });

      renderImportedContent();
      selectedPostIds.clear();
      renderSyncedPosts();
      showToast(`${selectedPosts.length} post${selectedPosts.length > 1 ? 's' : ''} imported!`, 'success');
    }

    // Load saved highlights from database (instant)
    async function loadSavedHighlights() {
      const loadBtn = document.getElementById('loadSavedHighlightsBtn');
      const statusEl = document.getElementById('highlightsStatus');
      const highlightsGrid = document.getElementById('igHighlightsGrid');

      // Show loading state
      loadBtn.disabled = true;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Loading...
      `;
      statusEl.textContent = 'Loading saved highlights...';
      statusEl.className = 'ig-import-status processing';

      try {
        const response = await fetch('/.netlify/functions/get-highlights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'load',
            creator_id: getCreatorId()
          })
        });

        const result = await response.json();

        if (result.success) {
          highlights = result.highlights || [];
          renderHighlights();
          highlightsGrid.style.display = 'block';
          statusEl.textContent = `Loaded ${highlights.length} saved highlights`;
          statusEl.className = 'ig-import-status success';
        } else {
          throw new Error(result.error || 'Failed to load highlights');
        }
      } catch (error) {
        console.error('Load highlights error:', error);
        statusEl.textContent = 'Failed to load: ' + error.message;
        statusEl.className = 'ig-import-status error';
      }

      // Reset button
      loadBtn.disabled = false;
      loadBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 8l-5-5-5 5M12 3v12"/>
        </svg>
        Load Saved
      `;
    }

    // Step 2: Get Instagram Highlights (fetch new from Instagram with polling)
    async function getInstagramHighlights() {
      const profileInput = document.getElementById('igProfileUrl');
      const highlightsBtn = document.getElementById('getHighlightsBtn');
      const statusEl = document.getElementById('highlightsStatus');
      const highlightsGrid = document.getElementById('igHighlightsGrid');

      const profileUrl = profileInput.value.trim();
      if (!profileUrl) {
        showToast('Please enter your Instagram profile URL first');
        return;
      }

      const username = extractUsername(profileUrl);
      if (!username) {
        showToast('Invalid Instagram profile URL');
        return;
      }

      // Show loading state
      highlightsBtn.disabled = true;
      highlightsBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Starting...
      `;
      statusEl.textContent = 'Starting highlights sync...';
      statusEl.className = 'ig-import-status processing';

      try {
        // Step 1: Start the sync (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/get-highlights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            profile_url: profileUrl,
            creator_id: getCreatorId()
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success) {
          throw new Error(startResult.error || 'Failed to start sync');
        }

        const runId = startResult.run_id;
        statusEl.textContent = `Syncing highlights for @${username}...`;
        highlightsBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          Syncing...
        `;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 60; // 5 minutes max

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
          attempts++;

          const pollResponse = await fetch('/.netlify/functions/get-highlights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              creator_id: getCreatorId()
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            highlights = pollResult.highlights || [];
            renderHighlights();
            highlightsGrid.style.display = 'block';
            statusEl.textContent = `Found ${highlights.length} highlight${highlights.length !== 1 ? 's' : ''}`;
            statusEl.className = 'ig-import-status success';
            showToast(`Found ${highlights.length} highlights!`, 'success');
            break;
          } else if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Sync failed');
          } else {
            statusEl.textContent = `Syncing highlights... (${attempts * 5}s)`;
          }
        }

        if (attempts >= maxAttempts) {
          throw new Error('Sync timed out after 5 minutes');
        }

      } catch (error) {
        console.error('Highlights error:', error);
        statusEl.textContent = 'Failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to load highlights: ' + error.message);
      }

      // Reset button
      highlightsBtn.disabled = false;
      highlightsBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        Sync New
      `;
    }

    // Render highlights grid
    function renderHighlights() {
      const container = document.getElementById('igHighlightsContainer');

      // Filter out highlights without valid IDs (need 10+ chars minimum)
      const validHighlights = highlights.filter(h => h.id && h.id.length >= 10);

      if (validHighlights.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No highlights found</p>';
        return;
      }

      // Use gradient placeholders since Instagram blocks direct image loading (CORS)
      // The title is what matters for selection
      const gradients = [
        'linear-gradient(135deg, #833AB4, #FD1D1D, #F77737)',
        'linear-gradient(135deg, #405DE6, #5851DB, #833AB4)',
        'linear-gradient(135deg, #F77737, #FCAF45, #FFDC80)',
        'linear-gradient(135deg, #C13584, #E1306C, #FD1D1D)',
        'linear-gradient(135deg, #5851DB, #833AB4, #C13584)'
      ];

      container.innerHTML = validHighlights.map((highlight, index) => {
        const gradient = gradients[index % gradients.length];
        const initial = (highlight.title || 'H')[0].toUpperCase();

        return `
          <div class="ig-highlight-item" onclick="downloadHighlightStories('${highlight.id}', '${(highlight.title || '').replace(/'/g, "\\'")}')">
            <div class="highlight-cover" style="background: ${gradient}; display: flex; align-items: center; justify-content: center;">
              <span style="color: white; font-size: 1.5rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${initial}</span>
            </div>
            <span class="highlight-title">${highlight.title || 'Untitled'}</span>
            ${highlight.storiesCount ? `<span class="highlight-count">${highlight.storiesCount} stories</span>` : ''}
          </div>
        `;
      }).join('');
    }

    // Step 3: Download stories from a highlight (async with polling)
    async function downloadHighlightStories(highlightId, highlightTitle) {
      const statusEl = document.getElementById('highlightsStatus');
      const storiesGrid = document.getElementById('igStoriesGrid');
      const storiesContainer = document.getElementById('igStoriesContainer');

      // Validate highlight ID before making request
      if (!highlightId || highlightId.length < 10) {
        statusEl.textContent = 'Invalid highlight ID. Please re-sync your highlights.';
        statusEl.className = 'ig-import-status error';
        return;
      }

      // Show loading state
      statusEl.textContent = `Downloading stories from "${highlightTitle || highlightId}"...`;
      statusEl.className = 'ig-import-status processing';

      try {
        // Step 1: Start the download (returns run_id immediately)
        const startResponse = await fetch('/.netlify/functions/download-stories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            highlight_id: highlightId,
            highlight_title: highlightTitle,
            creator_id: getCreatorId()
          })
        });

        const startResult = await startResponse.json();

        if (!startResult.success && startResult.status !== 'processing') {
          throw new Error(startResult.error || 'Failed to start stories download');
        }

        const runId = startResult.run_id;

        // Step 2: Poll for completion
        let attempts = 0;
        const maxAttempts = 30; // 30 * 2 seconds = 60 seconds max
        const pollInterval = 2000;

        while (attempts < maxAttempts) {
          await new Promise(resolve => setTimeout(resolve, pollInterval));
          attempts++;

          statusEl.textContent = `Downloading stories from "${highlightTitle}"... (${attempts * 2}s)`;

          const pollResponse = await fetch('/.netlify/functions/download-stories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              run_id: runId,
              highlight_title: highlightTitle,
              creator_id: getCreatorId()
            })
          });

          const pollResult = await pollResponse.json();

          if (pollResult.status === 'completed') {
            downloadedStories = pollResult.stories || [];
            renderDownloadedStories(highlightTitle);
            storiesGrid.style.display = 'block';
            statusEl.textContent = `Downloaded ${downloadedStories.length} stories from "${highlightTitle}"`;
            statusEl.className = 'ig-import-status success';
            showToast(`Downloaded ${downloadedStories.length} stories!`, 'success');
            return;
          }

          if (pollResult.status === 'failed') {
            throw new Error(pollResult.error || 'Stories download failed');
          }

          // Still processing, continue polling
        }

        throw new Error('Download timed out. Please try again.');
      } catch (error) {
        console.error('Download stories error:', error);
        statusEl.textContent = 'Failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to download stories: ' + error.message);
      }
    }

    // Render downloaded stories with selection
    function renderDownloadedStories(highlightTitle) {
      const container = document.getElementById('igStoriesContainer');
      selectedStoryIndices.clear();

      if (downloadedStories.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-light);">No stories found in this highlight</p>';
        return;
      }

      container.innerHTML = `
        <div class="stories-import-header">
          <span>${downloadedStories.length} stories from "${highlightTitle || 'Highlight'}"</span>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="selectAllStories()">Select All</button>
            <button type="button" class="btn btn-primary btn-sm" id="importSelectedStoriesBtn" onclick="importSelectedStories('${(highlightTitle || '').replace(/'/g, "\\'")}')">
              Import Selected (<span id="selectedStoryCount">0</span>)
            </button>
          </div>
        </div>
        <div class="stories-grid">
          ${downloadedStories.map((story, index) => {
            const isVideo = story.type === 'video';
            // Use cloudinary_url or thumbnail_url from backend
            const thumbnailSrc = story.cloudinary_url || story.thumbnail_url || story.thumbnailUrl || story.mediaUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23e5e5e5" width="100" height="100"/%3E%3C/svg%3E';

            return `
              <div class="ig-story-item" data-index="${index}" onclick="toggleStorySelection(${index})">
                <img src="${thumbnailSrc}" alt="Story ${index + 1}"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23e5e5e5%22 width=%22100%22 height=%22100%22/%3E%3C/svg%3E'">
                ${isVideo ? '<div class="story-type-badge"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>' : ''}
                <div class="post-select-indicator">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Toggle story selection
    function toggleStorySelection(index) {
      if (selectedStoryIndices.has(index)) {
        selectedStoryIndices.delete(index);
      } else {
        selectedStoryIndices.add(index);
      }
      updateStorySelectionUI();
    }

    // Select all stories
    function selectAllStories() {
      if (selectedStoryIndices.size === downloadedStories.length) {
        selectedStoryIndices.clear();
      } else {
        downloadedStories.forEach((_, index) => selectedStoryIndices.add(index));
      }
      updateStorySelectionUI();
    }

    // Update story selection UI
    function updateStorySelectionUI() {
      document.querySelectorAll('.ig-story-item').forEach((el, index) => {
        if (selectedStoryIndices.has(index)) {
          el.classList.add('selected');
        } else {
          el.classList.remove('selected');
        }
      });
      const countEl = document.getElementById('selectedStoryCount');
      if (countEl) countEl.textContent = selectedStoryIndices.size;
    }

    // Import selected stories
    function importSelectedStories(highlightTitle) {
      if (selectedStoryIndices.size === 0) {
        showToast('Please select stories to import');
        return;
      }

      const selectedStories = downloadedStories.filter((_, index) => selectedStoryIndices.has(index));

      selectedStories.forEach((story, index) => {
        importedContent.push({
          id: story.id || `story-${Date.now()}-${index}`,
          instagram_url: '',
          instagram_shortcode: `story-${story.id || index}`,
          content_type: story.type === 'video' ? 'Video' : 'Image',
          thumbnail_url: story.cloudinary_url || story.thumbnail_url || story.thumbnailUrl || story.mediaUrl,
          cloudinary_url: story.cloudinary_url || story.mediaUrl,
          cloudinary_video_url: story.type === 'video' ? (story.cloudinary_url || story.mediaUrl) : null,
          caption: `From highlight: ${highlightTitle || 'Stories'}`,
          status: 'ready'
        });
      });

      renderImportedContent();
      selectedStoryIndices.clear();
      updateStorySelectionUI();
      showToast(`${selectedStories.length} stories imported!`, 'success');
      updateImportedContentCount();
    }

    // Update imported content count display
    function updateImportedContentCount() {
      const countEl = document.getElementById('importedContentCount');
      if (countEl) countEl.textContent = importedContent.length;
    }

    // Generate itinerary with AI
    async function generateItineraryWithAI() {
      const numDays = parseInt(document.getElementById('numDays').value) || 4;
      const tripContext = document.getElementById('tripContext').value.trim();
      const generateBtn = document.getElementById('generateItineraryBtn');
      const statusEl = document.getElementById('generateStatus');

      if (importedContent.length === 0) {
        showToast('Please import some content first (posts or stories)');
        return;
      }

      // Show loading state
      generateBtn.disabled = true;
      generateBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;" width="20" height="20">
          <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        Generating...
      `;
      statusEl.textContent = 'AI is creating your itinerary...';
      statusEl.className = 'ig-import-status processing';

      try {
        const response = await fetch('/.netlify/functions/generate-itinerary', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            content: importedContent,
            num_days: numDays,
            context: tripContext,
            creator_id: getCreatorId()
          })
        });

        const result = await response.json();

        if (result.success) {
          // Populate the form with generated content
          if (result.title) {
            document.getElementById('title').value = result.title;
          }
          if (result.destination) {
            document.getElementById('destination').value = result.destination;
          }
          if (result.location) {
            document.getElementById('location').value = result.location;
          }
          if (result.duration) {
            document.getElementById('duration').value = result.duration;
          }
          if (result.intro) {
            document.getElementById('intro').value = result.intro;
          }

          // Best For tags
          if (result.best_for && result.best_for.length > 0) {
            // Clear existing tags
            document.querySelectorAll('#bestForTags .tag').forEach(t => t.remove());
            // Add new tags
            result.best_for.forEach(tag => addTag('bestForTags', tag));
          }

          // Generate days
          console.log('Generation result:', result);
          console.log('Days from result:', result.days);

          if (result.days && result.days.length > 0) {
            // Clear existing days
            const daysListEl = document.getElementById('daysList');
            daysListEl.innerHTML = '';

            // Add generated days using addDay function
            result.days.forEach((dayData, index) => {
              console.log('Adding day:', dayData);
              addDay({
                title: dayData.title || `Day ${index + 1}`,
                description: dayData.description || '',
                activities: dayData.activities || []
              });
            });
          } else {
            console.warn('No days in result or days array is empty');
          }

          // Populate gallery from imported content
          if (result.gallery && result.gallery.length > 0) {
            populateGallery(result.gallery);
          }

          statusEl.textContent = 'Itinerary generated successfully!';
          statusEl.className = 'ig-import-status success';
          showToast('Itinerary generated! Review and edit as needed.', 'success');

          // Scroll to top of form to show generated content
          document.getElementById('title').scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Update preview
          updatePreview();
        } else {
          throw new Error(result.error || 'Failed to generate itinerary');
        }
      } catch (error) {
        console.error('Generate error:', error);
        statusEl.textContent = 'Generation failed: ' + error.message;
        statusEl.className = 'ig-import-status error';
        showToast('Failed to generate itinerary: ' + error.message);
      }

      // Reset button
      generateBtn.disabled = false;
      generateBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
          <path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/>
          <path d="M17.8 11.8L19 13"/><path d="M15 9h0"/><path d="M17.8 6.2L19 5"/>
          <path d="m3 21 9-9"/><path d="M12.2 6.2L11 5"/>
        </svg>
        Generate Itinerary
      `;
    }

    // Preview modal
    function showPreviewModal() {
      const title = document.getElementById('title').value || 'Untitled Itinerary';
      const destination = document.getElementById('destination').value || '';
      const location = document.getElementById('location').value || '';
      const duration = document.getElementById('duration').value || '';
      const intro = document.getElementById('intro').value || '';
      const heroImage = itineraryData.heroImage || '';
      const heroFocalX = itineraryData.heroFocalX || 50;
      const heroFocalY = itineraryData.heroFocalY || 50;
      const bestFor = Array.from(document.querySelectorAll('#bestForTags .tag'))
        .map(t => t.textContent.trim().replace('', '').trim());

      // Get days
      const days = Array.from(document.getElementById('daysList').children).map((card, i) => ({
        dayNumber: i + 1,
        title: card.querySelector('.day-card-header input').value || `Day ${i + 1}`,
        description: card.querySelector('.day-description').value || '',
        activities: (card.querySelector('.day-activities').value || '').split(',').map(a => a.trim()).filter(Boolean)
      }));

      // Get gallery items
      const galleryItems = Array.from(document.querySelectorAll('#galleryGrid .gallery-item img')).map(img => img.src);

      // Create modal
      const modal = document.createElement('div');
      modal.className = 'preview-modal';
      modal.innerHTML = `
        <div class="preview-modal-content">
          <button class="preview-modal-close" onclick="this.closest('.preview-modal').remove()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
          <div class="preview-modal-body">
            ${heroImage ? `<div class="preview-hero"><img src="${heroImage}" alt="${title}" style="object-position: ${heroFocalX}% ${heroFocalY}%;"></div>` : ''}
            <div class="preview-header">
              <h1>${title}</h1>
              <p class="preview-meta">${[destination, location, duration].filter(Boolean).join('  ')}</p>
              ${bestFor.length > 0 ? `<div class="preview-tags">${bestFor.map(t => `<span class="preview-tag">${t}</span>`).join('')}</div>` : ''}
            </div>
            ${intro ? `<div class="preview-intro"><p>${intro}</p></div>` : ''}
            <div class="preview-days">
              <h2>Day by Day</h2>
              ${days.map(day => `
                <div class="preview-day">
                  <h3>${day.title}</h3>
                  <p>${day.description}</p>
                  ${day.activities.length > 0 ? `<p class="preview-activities"><strong>Activities:</strong> ${day.activities.join(', ')}</p>` : ''}
                </div>
              `).join('')}
            </div>
            ${galleryItems.length > 0 ? `
              <div class="preview-gallery">
                <h2>Gallery</h2>
                <div class="preview-gallery-grid">
                  ${galleryItems.map(src => `<img src="${src}" alt="">`).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
  </script>

  <!-- Preview Modal Styles -->
  <style>
    .preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px 20px;
    }

    .preview-modal-content {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    .preview-modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .preview-modal-close svg {
      width: 20px;
      height: 20px;
      color: white;
    }

    .preview-hero {
      width: 100%;
      height: 300px;
      overflow: hidden;
    }

    .preview-hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-modal-body {
      padding: 0;
    }

    .preview-header {
      padding: 32px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    .preview-header h1 {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .preview-meta {
      color: #666;
      margin-bottom: 16px;
    }

    .preview-tags {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .preview-tag {
      background: #f0f0f0;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.875rem;
    }

    .preview-intro {
      padding: 24px 32px;
      background: #f9f9f9;
      font-style: italic;
    }

    .preview-days {
      padding: 32px;
    }

    .preview-days h2 {
      font-size: 1.5rem;
      margin-bottom: 24px;
    }

    .preview-day {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }

    .preview-day:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .preview-day h3 {
      font-size: 1.125rem;
      margin-bottom: 8px;
      color: var(--color-accent, #c9a227);
    }

    .preview-activities {
      margin-top: 8px;
      color: #666;
      font-size: 0.9rem;
    }

    .preview-gallery {
      padding: 32px;
    }

    .preview-gallery h2 {
      font-size: 1.25rem;
      margin-bottom: 16px;
    }

    .preview-gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .preview-gallery-grid img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 8px;
    }
  </style>
</body>
</html>
